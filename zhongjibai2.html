<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Ti·∫øng Trung: Êàë‰∏çÂêÉËøô‰∏™ üêº (vFinal C·∫≠p Nh·∫≠t)</title>
    <style>
        /* ----- CSS ----- */
        body { font-family: sans-serif; line-height: 1.6; background-color: #f0f8ff; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; margin: 0; box-sizing: border-box; }
        #game-container { background-color: #ffffff; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); max-width: 800px; width: 100%; text-align: center; box-sizing: border-box; }
        h1 { color: #ff6347; margin-top: 0; }
        #timer-section { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: #4682b4; }
        #instructions p { background-color: #e0f7fa; border-left: 5px solid #00bcd4; padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: left; font-size: 1.1em; }
        #game-area { margin-bottom: 20px; text-align: left; }

        .stage-title { font-size: 1.5em; color: #007bff; margin-bottom: 15px; text-align: center; }

        /* CSS cho M√†n N·ªëi T·ª´ (Click-to-Match) */
        #vocab-matching-area { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; min-height: 300px; }
        .vocab-columns-container { display: flex; justify-content: space-around; width: 100%; }
        .vocab-list-column, .meaning-list-column { width: 45%; padding: 10px; border: 1px dashed #ccc; border-radius: 5px; min-height: 250px; }
        .selectable-word, .selectable-meaning {
            padding: 8px 12px; margin: 8px 0; border-radius: 5px; cursor: pointer; border: 1px solid #eee; text-align: center;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .selectable-word { background-color: #fffacd; }
        .selectable-meaning { background-color: #e0f7fa; border: 1px dashed #00bcd4; min-height: 30px; display: flex; align-items: center; justify-content: center;}

        .selectable-word.selected { background-color: #ffc107; border-color: #e0a800; font-weight: bold; }
        .selectable-word.matched, .selectable-meaning.matched {
            cursor: default;
            opacity: 0.6;
        }
        .selectable-meaning.matched.correct {
            background-color: #d4edda; color: #155724; border-color: #c3e6cb; font-weight: bold;
        }
        .selectable-meaning.matched.incorrect {
            background-color: #f8d7da; color: #721c24;
        }
        .selectable-meaning .placed-word {
            font-style: italic; color: #555;
        }

        .fill-sentence { margin-bottom: 10px; font-size: 1.1em; }
        .fill-sentence select { padding: 5px; font-size: 1em; margin: 0 5px; border-radius: 4px; }
        .sentence-completion-item { margin-bottom: 15px; }
        .sentence-completion-item label { display: block; margin-bottom: 5px; font-weight: normal; }
        /* S·ª≠a chi·ªÅu r·ªông input cho Sentence Completion */
        .sentence-completion-item input[type="text"] {
             width: calc(60% - 12px); /* ƒêi·ªÅu ch·ªânh ƒë·ªÉ c√≥ kh√¥ng gian cho suffix */
             padding: 8px;
             font-size: 0.95em;
             margin-right: 5px; /* Kho·∫£ng c√°ch v·ªõi suffix */
             border: 1px solid #ccc;
             border-radius: 4px;
        }
        #reading-passage { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; line-height: 1.7; text-align: left; max-height: 300px; overflow-y: auto;}
        #reading-passage p { margin-bottom: 0.8em !important; }
        .reading-narrative { color: grey; font-style: italic; margin-bottom: 10px !important; }
        .speaker-line strong { font-weight: bold; }
        .speaker-zhangxiaowei { color: #007bff; }
        .speaker-puzhihui { color: #28a745; }
        .speaker-shanxiaheye { color: #fd7e14; }
        .speaker-fengshangde { color: #6f42c1; }
        .speaker-chenxinyang { color: #d63384; }
        .speaker-default { color: #343a40; }

        .reading-question { margin-bottom: 15px; }
        .reading-question label { display: block; margin-bottom: 5px; font-weight: normal; }
        .reading-question textarea { width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; min-height: 60px; }
        #sc-current-word-area { margin-bottom: 20px; padding: 15px; background-color: #fffacd; border-radius: 8px; text-align: center; }
        #sc-current-word-hanzi { font-size: 1.8em; font-weight: bold; display: block; margin-bottom: 5px;}
        #sc-current-word-pinyin { font-size: 1.1em; color: grey; display: block;}
        #sc-current-word-meaning { font-size: 1em; color: #555; display: block; margin-top: 5px; font-style: italic;}
        #sc-sentence-input { box-sizing: border-box; width: 100%; padding: 15px; font-size: 1.1em; border: 1px solid #ccc; border-radius: 5px; min-height: 80px; margin-bottom: 15px; display: block; }
        #paragraph-writing-prompt { background-color: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 10px; text-align: left; font-size: 0.9em;}
        #paragraph-writing-prompt h4 { margin-top: 0; }
        #paragraph-input { width: calc(100% - 22px); min-height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #char-count { font-size: 0.9em; color: #6c757d; text-align: right; }
        #current-word-area { margin-bottom: 20px; padding: 15px; background-color: #fffacd; border-radius: 8px; text-align: center; }
        #current-word-hanzi { font-size: 1.8em; font-weight: bold; display: block; margin-bottom: 5px;}
        #current-word-pinyin { font-size: 1.1em; color: grey; display: block;}
        #current-word-meaning { font-size: 1em; color: #555; display: block; margin-top: 5px; font-style: italic;}
        #sentence-input { box-sizing: border-box; width: 100%; padding: 15px; font-size: 1.1em; border: 1px solid #ccc; border-radius: 5px; min-height: 80px; margin-bottom: 15px; display: block; }
        .paragraph-container { font-size: 1.2em; line-height: 1.8; margin-bottom: 20px; background-color: #f8f8f8; padding: 20px; border-radius: 8px; border: 1px solid #eee; text-align: left; }
        .blank-input { width: auto; min-width: 50px; border: none; border-bottom: 2px solid #4682b4; padding: 2px 5px; font-size: 1em; text-align: center; margin: 0 3px; background-color: transparent; vertical-align: baseline; }
        .new-word { color: red; font-weight: bold; cursor: pointer; position: relative; }
        .tooltip { display: none; position: absolute; background-color: #333; color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 0.9em; z-index: 10; white-space: normal; max-width: 250px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-align: left; }
        .tooltip span { display: block; margin-bottom: 3px; }
        .tooltip span:last-child { margin-bottom: 0; }
        #hint-section { margin-bottom: 20px; }
        #hint-text { color: #6a5acd; font-style: italic; min-height: 20px; margin-top: 10px; }
        #feedback-section { margin-top: 15px; padding: 10px; border-radius: 5px; min-height: 30px; display: none; word-wrap: break-word; text-align: left; }
        #feedback-section.correct { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        #feedback-section.incorrect { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        #feedback-section.info { background-color: #cce5ff; color: #004085; border: 1px solid #b8daff; }
        button { background-color: #ff6347; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-size: 1em; transition: background-color 0.3s ease, transform 0.1s ease; margin: 10px 5px 5px 5px; }
        button:hover { background-color: #e5533d; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #summary-page { background-color: #e6f7ff; padding: 30px; border-radius: 10px; margin-top: 20px; text-align: left; display: none; }
        #summary-page h2 { text-align: center; color: #1890ff; }
        #summary-errors { padding-left: 20px; }
        #summary-errors li { color: #d9534f; margin-bottom: 5px; list-style: disc; }
        #summary-errors small { color: #555; }

        /* CSS cho ph·∫ßn hi·ªÉn th·ªã c√¢u ƒë√£ l∆∞u ·ªü trang t·ªïng k·∫øt */
        .summary-saved-answers-container { margin-top: 20px;}
        .summary-saved-answers-container h3 {color: #007bff;}
        .summary-saved-answers-list { padding-left: 20px; list-style: decimal; }
        .summary-saved-answers-list li { margin-bottom: 10px; line-height: 1.5; }
        .summary-saved-answers-list li strong { display: block; } /* Cho ph·∫ßn "T·ª´:" ho·∫∑c "C√¢u g·ªëc:" */
        .summary-saved-answers-list li em { font-style: italic; color: #333; background-color: #f0f0f0; padding: 0 3px; border-radius: 3px;} /* Cho ph·∫ßn ng∆∞·ªùi d√πng nh·∫≠p */


        #submit-reminder { font-size: 1.25em; font-weight: bold; color: #856404; background-color: #fff3cd; padding: 15px; border-left: 6px solid #ffeeba; border-radius: 5px; margin-top: 25px; margin-bottom: 25px; text-align: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>Game Ti·∫øng Trung: Êàë‰∏çÂêÉËøô‰∏™ ü•¢</h1>
        <div id="timer-section">‚è≥ Th·ªùi gian: <span id="timer">00:00</span></div>
        <div id="instructions"><p>üíñ Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi b√†i h·ªçc "T√¥i kh√¥ng ƒÉn c√°i n√†y"! H√£y c√πng kh√°m ph√° nh√©!</p></div>
        <div id="game-area"></div>
        <div id="hint-section"><button id="hint-button" class="hidden">üí° G·ª£i √Ω cho t√¥i n√†o!</button><p id="hint-text"></p></div>
        <div id="feedback-section"><p id="feedback-text"></p></div>
        <div id="navigation-buttons" style="margin-top: 20px; text-align: center;">
            <button id="next-stage-button" class="hidden" style="background-color: #17a2b8;">Ti·∫øp t·ª•c M√†n Sau ‚ñ∂Ô∏è</button>
        </div>
    </div>
    <div id="tooltip" class="tooltip"><span id="tooltip-hanzi"></span><span id="tooltip-pinyin"></span><span id="tooltip-meaning"></span></div>
    <div id="summary-page">
        <h2>üéâ Ho√†n Th√†nh! üéâ</h2>
        <p>T√™n h·ªçc vi√™n: <span id="summary-player-name"></span></p>
        <p>T·ªïng th·ªùi gian: <span id="summary-time"></span></p>
        <p>S·ªë c√¢u ƒë√∫ng (tr·∫Øc nghi·ªám/ƒëi·ªÅn t·ª´): <span id="summary-correct"></span> (T·ªïng s·ªë c√¢u h·ªèi c√≥ ch·∫•m ƒëi·ªÉm t·ª± ƒë·ªông: <span id="total-questions-summary"></span>)</p>
        <p>S·ªë c√¢u sai (tr·∫Øc nghi·ªám/ƒëi·ªÅn t·ª´): <span id="summary-incorrect"></span></p>
        <h3>Chi ti·∫øt l·ªói sai (n·∫øu c√≥):</h3>
        <ul id="summary-errors"></ul>

        <div id="summary-sentence-completions-container" class="summary-saved-answers-container">
            <h3>C√°c c√¢u ƒë√£ ho√†n th√†nh (ch·ªù gi√°o vi√™n ch·∫•m):</h3>
            <ul id="summary-sentence-completions" class="summary-saved-answers-list"></ul>
        </div>

        <div id="summary-sentence-creations-container" class="summary-saved-answers-container">
            <h3>C√°c c√¢u ƒë√£ ƒë·∫∑t (ch·ªù gi√°o vi√™n ch·∫•m):</h3>
            <ul id="summary-sentence-creations" class="summary-saved-answers-list"></ul>
        </div>

        <p id="submit-reminder">C√°c b·∫°n nh·ªõ ·∫•n n·ªôp k·∫øt qu·∫£ l√™n Google Form nh√©</p>
        <button id="submit-report-button" style="background-color: #28a745;">N·ªôp B√°o C√°o L√™n Google Form üìã</button>
        <button id="restart-button">Ch∆°i l·∫°i t·ª´ ƒë·∫ßu üîÅ</button>
    </div>

    <script>
        // ----- D·ªÆ LI·ªÜU TR√í CH∆†I M·ªöI (Gi·ªØ nguy√™n t·ª´ l·∫ßn tr∆∞·ªõc) -----
        const vocabMatchingData = [ { id: 1, hanzi: 'Âèó‰∏ç‰∫Ü', pinyin: 'sh√≤ubuli«éo', meaning: 'kh√¥ng ch·ªãu n·ªïi / cannot stand/bear', type: 'word' }, { id: 2, hanzi: 'Ëæ£Ê§í', pinyin: 'l√†jiƒÅo', meaning: '·ªõt / chilli pepper', type: 'word' }, { id: 3, hanzi: 'È£üÁâ©', pinyin: 'sh√≠w√π', meaning: 'th·ª±c ph·∫©m, ƒë·ªì ƒÉn / food', type: 'word' }, { id: 4, hanzi: 'ÂåÖÊã¨', pinyin: 'bƒÅoku√≤', meaning: 'bao g·ªìm / include', type: 'word' }, { id: 5, hanzi: 'ÂÜÖËÑè', pinyin: 'n√®iz√†ng', meaning: 'n·ªôi t·∫°ng / internal organs', type: 'word' }, { id: 6, hanzi: 'Ê∏ÖÁúü', pinyin: 'qƒ´ngzhƒìn', meaning: '(ƒë·ªì ƒÉn) Halal / Muslim', type: 'word' }, { id: 7, hanzi: 'Á©ÜÊñØÊûó', pinyin: 'm√∫sil√≠n', meaning: 'ng∆∞·ªùi H·ªìi gi√°o / Muslim', type: 'word' }, { id: 8, hanzi: 'ËÇâÈ£ü', pinyin: 'r√≤ush√≠', meaning: 'th·ªãt (ƒÉn ƒë∆∞·ª£c) / edible meat', type: 'word' }, { id: 9, hanzi: 'ËøáÊïè', pinyin: 'gu√≤m«ên', meaning: 'd·ªã ·ª©ng / be allergic to', type: 'word' }, { id: 10, hanzi: 'È∏°Áà™Â≠ê', pinyin: 'jƒ´zhu«ézi', meaning: 'ch√¢n g√† / chicken\'s foot', type: 'word' }, { id: 11, hanzi: 'ÈªëÊöóÊñôÁêÜ', pinyin: 'hƒìi\'√†n li√†ol«ê', meaning: '"·∫©m th·ª±c b√≥ng t·ªëi" / dark cuisine', type: 'word' }, { id: 12, hanzi: 'Ê≤πËÖª', pinyin: 'y√≥un√¨', meaning: 'd·∫ßu m·ª°, ng·∫•y / oily', type: 'word' }, { id: 13, hanzi: 'ÁÉ§È±º', pinyin: 'k«éoy√∫', meaning: 'c√° n∆∞·ªõng / broiled/roast fish', type: 'word' }, { id: 14, hanzi: 'Ëî¨Ëèú', pinyin: 'sh≈´c√†i', meaning: 'rau c·ªß / vegetables', type: 'word' }, { id: 15, hanzi: 'Á¥†È£ü', pinyin: 's√πsh√≠', meaning: 'ƒë·ªì chay, ƒÉn chay / vegetarian meal', type: 'word' }, { id: 16, hanzi: 'ÂØºËá¥', pinyin: 'd«éozh√¨', meaning: 'd·∫´n ƒë·∫øn / lead to', type: 'word' }, { id: 17, hanzi: 'Ëê•ÂÖª', pinyin: 'y√≠ngy«éng', meaning: 'dinh d∆∞·ª°ng / nutrition', type: 'word' }, { id: 18, hanzi: '‰∏çË∂≥', pinyin: 'b√πz√∫', meaning: 'kh√¥ng ƒë·ªß / insufficient', type: 'word' }, { id: 19, hanzi: 'ÊãíÁªù', pinyin: 'j√πju√©', meaning: 't·ª´ ch·ªëi / refuse', type: 'word' }, { id: 20, hanzi: 'Ë∫´Êùê', pinyin: 'shƒìnc√°i', meaning: 'v√≥c d√°ng / stature; figure', type: 'word' }, { id: 21, hanzi: 'ÂÖÖÊª°', pinyin: 'ch≈çngm«én', meaning: 'tr√†n ƒë·∫ßy / be filled with', type: 'word' }, { id: 22, hanzi: 'ÂäõÈáè', pinyin: 'l√¨liang', meaning: 's·ª©c l·ª±c / physical strength', type: 'word' }, { id: 23, hanzi: 'Áñ≤Âä≥', pinyin: 'p√≠l√°o', meaning: 'm·ªát m·ªèi / tired', type: 'word' }, { id: 24, hanzi: 'È¶ôËèú', pinyin: 'xiƒÅngc√†i', meaning: 'rau m√πi / coriander', type: 'word' } ];
        const vocabFillData = { options: ["Âèó‰∏ç‰∫Ü", "Ëæ£Ê§í", "È£üÁâ©", "ÂåÖÊã¨", "ÂÜÖËÑè", "Ê∏ÖÁúü", "ËøáÊïè", "Ê≤πËÖª", "Ëî¨Ëèú", "Á¥†È£ü", "ÂØºËá¥", "Ëê•ÂÖª", "ÊãíÁªù", "È¶ôËèú"], sentences: [ { parts: ["ÂõõÂ∑ùÁÅ´ÈîÖÂ§™Ëæ£‰∫ÜÔºåÊàëÊúâÁÇπÂÑø ", { placeholderID: "vf_1", answer: "Âèó‰∏ç‰∫Ü" }, "„ÄÇ"] }, { parts: ["ÂæàÂ§öÂ§ñÂõΩ‰∫∫‰∏ç‰π†ÊÉØÂêÉÂä®Áâ©ÁöÑ ", { placeholderID: "vf_2", answer: "ÂÜÖËÑè" }, "„ÄÇ"] }, { parts: ["ËøôÂÆ∂ ", { placeholderID: "vf_3", answer: "Ê∏ÖÁúü" }, " È•≠È¶ÜÂÅöÁöÑÁæäËÇâ‰∏≤ÂæàÂ•ΩÂêÉ„ÄÇ"] }, { parts: ["ÊàëÂØπÊµ∑È≤ú ", { placeholderID: "vf_4", answer: "ËøáÊïè" }, "Ôºå‰∏ÄÂêÉË∫´‰∏äÂ∞±Áóí„ÄÇ"] }, { parts: ["ËøôÁßç ", { placeholderID: "vf_5a", answer: "È£üÁâ©" }, " Â§™ ", { placeholderID: "vf_5b", answer: "Ê≤πËÖª" }, " ‰∫ÜÔºåÂêÉÂ§ö‰∫ÜÂØπË∫´‰Ωì‰∏çÂ•Ω„ÄÇ"] }, { parts: ["‰∏∫‰∫ÜÂÅ•Â∫∑Ôºå‰ªñÁé∞Âú®ÂºÄÂßãÂêÉ ", { placeholderID: "vf_6", answer: "Á¥†È£ü" }, " ‰∫Ü„ÄÇ"] }, { parts: ["Â§öÂêÉ ", { placeholderID: "vf_7", answer: "Ëî¨Ëèú" }, " ÂØπË∫´‰ΩìÂ•ΩÔºåÂèØ‰ª•Ë°•ÂÖÖÁª¥ÁîüÁ¥†„ÄÇ"] }, { parts: ["ÈïøÊúü‰∏çÂêÉËÇâÂèØËÉΩ‰ºö ", { placeholderID: "vf_8a", answer: "ÂØºËá¥" }, " ", { placeholderID: "vf_8b", answer: "Ëê•ÂÖª" }, " ‰∏çË∂≥„ÄÇ"] }, { parts: ["ÊàëÂ¶àÂ¶à‰∏çÂñúÊ¨¢ ", { placeholderID: "vf_9", answer: "È¶ôËèú" }, " ÁöÑÂë≥ÈÅìÔºåÊâÄ‰ª•Êàë‰ª¨ÂÆ∂ÂÅöËèú‰ªéÊù•‰∏çÊîæ„ÄÇ"] }, { parts: ["Ëøô‰ªΩÂ•óÈ§ê ", { placeholderID: "vf_10", answer: "ÂåÖÊã¨" }, " ‰∏Ä‰ªΩ‰∏ªÈ£ü„ÄÅ‰∏Ä‰ªΩÊ±§Âíå‰∏ÄÊùØÈ•ÆÊñô„ÄÇ"] } ] };
        const sentenceCompletionData = [ { id: "sc_1", starter: "ÊàëÂèó‰∏ç‰∫Ü ", exampleSuffix: " ÁöÑÂë≥ÈÅì„ÄÇ (V√≠ d·ª•: Ëá≠Ë±ÜËÖê)" }, { id: "sc_2", starter: "Êó•Êú¨È•ÆÈ£üÊ∏ÖÊ∑°ÔºåÊâÄ‰ª•Âë≥ÈÅìÊØîËæÉÈáçÁöÑÈ£üÁâ©‰∏çÂ§™ÂèóÊ¨¢ËøéÔºå", exampleSuffix: " Âä®Áâ©ÁöÑÂÜÖËÑè„ÄÇ" }, { id: "sc_3", starter: "ÊàëÂØπ ", exampleSuffix: " ËøáÊïèÔºåÊâÄ‰ª•‰∏ÄÁÇπÂÑøÈÉΩ‰∏çËÉΩÂêÉ„ÄÇ (V√≠ d·ª•: Ëä±Áîü)" }, { id: "sc_4", starter: "Áî±‰∫é ", exampleSuffix: "ÔºåÊâÄ‰ª•ÊàëÂÜ≥ÂÆö‰ªäÂ§©Âú®ÂÆ∂‰ºëÊÅØ„ÄÇ (N√™u l√Ω do)" }, { id: "sc_5", starter: "‰ªñ‰∏ç‰ªÖÂ≠¶‰π†Â•ΩÔºå", exampleSuffix: " ËøòÂæàÂñúÊ¨¢Â∏ÆÂä©ÂêåÂ≠¶„ÄÇ" }, { id: "sc_6", starter: "ÊàëËßâÂæóÂ≠¶Â•ΩÊ±âËØ≠ÊúÄÂÖ≥ÈîÆÁöÑÊòØ ", exampleSuffix: "„ÄÇ" } ];
        const readingCompData = { passage: "(Êñ∞Â≠¶Êúü,ÂÖ®Áè≠Ë¶ÅËÅöÈ§ê,Â§ßÂÆ∂Ê≠£Âú®ÂïÜÈáèÂéªÂêÉ‰ªÄ‰πà„ÄÇ)\nÂº†Â∞èËñá: ÂêåÂ≠¶‰ª¨,Âë®‰∫î‰∏ãËØæÂêéÊàë‰ª¨‰∏ÄËµ∑ÂéªÂêÉ‰∏™È•≠ÊÄé‰πàÊ†∑?\nÊú¥Êô∫ÊÖß: Â•ΩÂïä,‰Ω†‰ª¨ÊÉ≥ÂêÉ‰ªÄ‰πà?\nÂ±±‰∏ãÂíå‰πü: ÂéªÂêÉÂõõÂ∑ùÁÅ´ÈîÖÂêß!Êàë‰∏ÄÁõ¥ÈÉΩÊÉ≥ËØïËØïÂ∑ùËèú„ÄÇ\nÊú¥Êô∫ÊÖß: ÂõõÂ∑ùÁÅ´ÈîÖ?ÊàëÂíåÊúãÂèãÂêÉËøá‰∏ÄÊ¨°,Ëæ£ÂæóÊàëÁõ¥ÊµÅÁúºÊ≥™„ÄÇÊàëÂèó‰∏ç‰∫Ü‰∏≠ÂõΩÁöÑËæ£Ê§í,‰πü‰∏çÂ§™ÂñúÊ¨¢ÁæäËÇâ„ÄÇ\nÂÜØÂ∞öÂæ∑: ÈÇ£Âí±‰ª¨Êç¢‰∏™È•≠È¶Ü„ÄÇÂ±±‰∏ã,Êó•Êú¨‰∫∫ÈÉΩ‰∏çÂêÉÁæäËÇâÂêó?\nÂ±±‰∏ãÂíå‰πü: Â§ßÈÉ®ÂàÜÊó•Êú¨‰∫∫ÈÉΩ‰∏çÂ§™ÂñúÊ¨¢ÁæäËÇâ„ÄÇÊó•Êú¨È•ÆÈ£üÊ∏ÖÊ∑°,ÊâÄ‰ª•Âë≥ÈÅìÊØîËæÉÈáçÁöÑÈ£üÁâ©‰∏çÂ§™ÂèóÊ¨¢Ëøé,ÂåÖÊã¨Âä®Áâ©ÁöÑÂÜÖËÑè„ÄÇ\nÂº†Â∞èËñá: ÊàëËßâÂæóÊúÄÂ•ΩÊâæ‰∏Ä‰∏™Ê∏ÖÁúüÈ•≠È¶Ü,Êñ∞Èò≥ÊòØÁ©ÜÊñØÊûó„ÄÇ\nÈôàÊñ∞Èò≥: Ë∞¢Ë∞¢Â∞èËñá!Êàë‰∏çÂêÉÈùûÊ∏ÖÁúüÁöÑËÇâÈ£ü„ÄÇ\nÂÜØÂ∞öÂæ∑: ÈÇ£Êàë‰ª¨ÂéªÂêÉ‰ªÄ‰πà?Â∞èËñá,‰Ω†Áü•ÈÅìÂì™ÂÑøÊúâÂ•ΩÂêÉÁöÑÂêó?\nÂº†Â∞èËñá: ÊàëÊÉ≥ÊÉ≥„ÄÇÂ∞öÂæ∑„ÄÅÊô∫ÊÖß,‰Ω†‰ª¨‰ø©Êúâ‰ªÄ‰πà‰∏çÂêÉÁöÑÂêó?ÂØπ‰ªÄ‰πàÈ£üÁâ©ËøáÊïè?\nÂÜØÂ∞öÂæ∑: ËøáÊïèÂÄíÊ≤°Êúâ,‰ΩÜÊòØÊàë‰πü‰∏çÂñúÊ¨¢ÂêÉÂÜÖËÑè„ÄÅÈ∏°Áà™Â≠ê‰πãÁ±ªÁöÑ„ÄÇÂÜÖËÑèÊúâÁßçÂ•áÊÄ™ÁöÑÂë≥ÈÅì,È∏°Áà™Â≠êÁúãËµ∑Êù•ÂÉè‰∫∫ÁöÑÊâã„ÄÇÂØπÊàëÊù•ËØ¥Ëøô‰∫õÈÉΩÊòØ‚ÄúÈªëÊöóÊñôÁêÜ‚Äù„ÄÇ\nÊú¥Êô∫ÊÖß: Êàë‰∏çÊÉ≥ÂêÉÂø´È§êÁ≠âÂ§™Ê≤πËÖªÁöÑÈ£üÁâ©,‰∏çÂÅ•Â∫∑,ÊúÄÂÖ≥ÈîÆÁöÑÊòØÂêÉ‰∏ÄÂè£Â∞±ËÉñ„ÄÇ‰∏çËøáËøôÊ†∑‰∏ÄÊù•,‰πüÂ∞ë‰∫ÜÂæàÂ§öÂêÉÂø´È§êÁöÑÂø´‰πê„ÄÇ\nÂº†Â∞èËñá: ÂèàÂ•ΩÂêÉÂèàÂÅ•Â∫∑ÁöÑÁÉ§È±º?\nÂ±±‰∏ãÂíå‰πü„ÄÅÈôàÊñ∞Èò≥„ÄÅÂÜØÂ∞öÂæ∑„ÄÅÊú¥Êô∫ÊÖß: ÂêåÊÑè!\nÂº†Â∞èËñá: ÈÇ£Êàë‰ª¨ÂéªÂêÉÊ∏ÖÁúüÁÉ§È±ºÂêß,ÊúâËæ£ÁöÑ,‰πüÊúâ‰∏çËæ£ÁöÑ,ËøòÂèØ‰ª•Êîæ‰∫õËî¨Ëèú„ÄÇ", questions: [ { id: "rc_q1", text: "‰ªñ‰ª¨‰∏∫‰ªÄ‰πàÊ≤°ÂéªÂêÉÂõõÂ∑ùÁÅ´ÈîÖ? (ËØ∑Áî®‚ÄúÂèó‰∏ç‰∫Ü‚ÄùÂíå‚ÄúËæ£Ê§í‚ÄùÂõûÁ≠î)", keywords: ["Âèó‰∏ç‰∫Ü", "Ëæ£Ê§í"] }, { id: "rc_q2", text: "‰ªÄ‰πàÊ†∑ÁöÑÈ£üÁâ©Âú®Êó•Êú¨‰∏çÂ§™ÂèóÊ¨¢Ëøé? (ËØ∑Áî®‚ÄúÈ£üÁâ©‚Äù, ‚ÄúÂåÖÊã¨‚ÄùÂíå‚ÄúÂÜÖËÑè‚ÄùÂõûÁ≠î)", keywords: ["È£üÁâ©", "ÂåÖÊã¨", "ÂÜÖËÑè"] }, { id: "rc_q3", text: "Âº†Â∞èËñá‰∏∫‰ªÄ‰πàÂª∫ËÆÆÂéªÊ∏ÖÁúüÈ•≠È¶Ü? (ËØ∑Áî®‚ÄúÊ∏ÖÁúü‚Äù, ‚ÄúÁ©ÜÊñØÊûó‚ÄùÂíå‚ÄúËÇâÈ£ü‚ÄùÂõûÁ≠î)", keywords: ["Ê∏ÖÁúü", "Á©ÜÊñØÊûó", "ËÇâÈ£ü"] }, { id: "rc_q4", text: "ÂÜØÂ∞öÂæ∑‰∏çÂêÉ‰ªÄ‰πà? (ËØ∑Áî®‚ÄúÂÜÖËÑè‚Äù, ‚ÄúÈ∏°Áà™Â≠ê‚ÄùÂíå‚ÄúÈªëÊöóÊñôÁêÜ‚ÄùÂõûÁ≠î)", keywords: ["ÂÜÖËÑè", "È∏°Áà™Â≠ê", "ÈªëÊöóÊñôÁêÜ"] }, { id: "rc_q5", text: "Êú¥Êô∫ÊÖß‰∏çÊÉ≥ÂêÉ‰ªÄ‰πà?‰∏∫‰ªÄ‰πà? (ËØ∑Áî®‚ÄúÈ£üÁâ©‚ÄùÂíå‚ÄúÊ≤πËÖª‚ÄùÂõûÁ≠î)", keywords: ["È£üÁâ©", "Ê≤πËÖª"] }, { id: "rc_q6", text: "‰ªñ‰ª¨ÊúÄÂêéÂÜ≥ÂÆöÂéªÂêÉ‰ªÄ‰πà?‰∏∫‰ªÄ‰πà? (ËØ∑Áî®‚ÄúÁÉ§È±º‚ÄùÂíå‚ÄúËî¨Ëèú‚ÄùÂõûÁ≠î)", keywords: ["ÁÉ§È±º", "Ëî¨Ëèú"] } ] };
        const sentenceCreationWordsNew = [ { hanzi: 'Ëæ£Ê§í', pinyin: 'l√†jiƒÅo', meaning: '·ªõt / chilli pepper' }, { hanzi: 'ÂÜÖËÑè', pinyin: 'n√®iz√†ng', meaning: 'n·ªôi t·∫°ng / internal organs' }, { hanzi: 'Ê≤πËÖª', pinyin: 'y√≥un√¨', meaning: 'd·∫ßu m·ª°, ng·∫•y / oily' }, { hanzi: 'ËøáÊïè', pinyin: 'gu√≤m«ên', meaning: 'd·ªã ·ª©ng / be allergic to' }, { hanzi: 'Á¥†È£ü', pinyin: 's√πsh√≠', meaning: 'ƒë·ªì chay, ƒÉn chay / vegetarian meal' }, { hanzi: 'ÂØºËá¥', pinyin: 'd«éozh√¨', meaning: 'd·∫´n ƒë·∫øn / lead to' }, { hanzi: 'ÊãíÁªù', pinyin: 'j√πju√©', meaning: 't·ª´ ch·ªëi / refuse' }, { hanzi: 'Áñ≤Âä≥', pinyin: 'p√≠l√°o', meaning: 'm·ªát m·ªèi / tired' } ];
        const paragraphWritingData = { title: "ÊàëÁöÑÈ•ÆÈ£üÂÅèÂ•Ω (S·ªü th√≠ch ƒÉn u·ªëng c·ªßa t√¥i)", instructions: "H√£y vi·∫øt m·ªôt ƒëo·∫°n vƒÉn (kho·∫£ng 100-150 ch·ªØ) gi·ªõi thi·ªáu v·ªÅ m·ªôt lo·∫°i ƒë·ªì ƒÉn b·∫°n kh√¥ng ƒÉn/kh√¥ng th√≠ch. H√£y gi·∫£i th√≠ch l√Ω do v√† n√≥i v·ªÅ nh·ªØng ·∫£nh h∆∞·ªüng (t·ªët ho·∫∑c kh√¥ng t·ªët) c·ªßa th√≥i quen ƒÉn u·ªëng n√†y ƒë·ªëi v·ªõi b·∫°n.", structureHint: "C·∫•u tr√∫c g·ª£i √Ω (tham kh·∫£o trang 9  v√† trang 10 ):\nÊàë‰∏çÂñúÊ¨¢/Âèó‰∏ç‰∫Ü... (M√≥n kh√¥ng th√≠ch/kh√¥ng ch·ªãu ƒë∆∞·ª£c):‰æãÂ¶ÇÔºöÊàë‰∏çÂêÉ/‰∏çÂñúÊ¨¢/Âèó‰∏ç‰∫ÜÈ¶ôËèú„ÄÇ\nÂéüÂõ† (L√Ω do):Áî±‰∫é... (V√≠ d·ª•: Áî±‰∫éÂÆÉÁöÑÂë≥ÈÅìÂæàÂ•áÊÄ™...)\nÊàñËÄÖ: Âõ†‰∏∫... (V√≠ d·ª•: Âõ†‰∏∫ÊàëÂØπÂÆÉËøáÊïè„ÄÇ)\nÊúÄÂÖ≥ÈîÆÁöÑÊòØ... (V√≠ d·ª•: ÊúÄÂÖ≥ÈîÆÁöÑÊòØÔºåÂêÉ‰∫Ü‰ª•ÂêéÊàë‰ºö‰∏çËàíÊúç„ÄÇ)\nÂΩ±Âìç (·∫¢nh h∆∞·ªüng - c√≥ th·ªÉ l√† Â•ΩÂ§Ñ ho·∫∑c ÈóÆÈ¢ò):\nÂ•ΩÂ§Ñ (M·∫∑t t·ªët):ÊàëËÆ§‰∏∫‰∏çÂêÉ...ÊúâÂà©‰∫é... (V√≠ d·ª•: ÊàëËÆ§‰∏∫‰∏çÂêÉÊ≤πËÖªÁöÑÈ£üÁâ©ÊúâÂà©‰∫éÂÅ•Â∫∑„ÄÇ)\n‰∏çÂêÉ...ÁªôÊàëÂ∏¶Êù•ÂæàÂ§öÂ•ΩÂ§Ñ„ÄÇÈ¶ñÂÖà...ÔºåÂÖ∂Ê¨°...ÔºåÊõ¥ÈáçË¶ÅÁöÑÊòØ...\nÈóÆÈ¢ò (V·∫•n ƒë·ªÅ):‰∏çÂêÉ...ÁªôÊàëÂ∏¶Êù•ÂæàÂ§öÈ∫ªÁÉ¶„ÄÇ (V√≠ d·ª•: ‰∏çÂêÉËæ£ÁªôÊàëÁÇπËèúÂ∏¶Êù•ÂæàÂ§öÈ∫ªÁÉ¶„ÄÇ)\n‰∏ç‰ªÖ...ÔºåËÄå‰∏î... (V√≠ d·ª•: ËøôÁßçÈ•ÆÈ£ü‰π†ÊÉØ‰∏ç‰ªÖËÆ©ÊàëÂæàÈöæÂíåÊúãÂèã‰∏ÄËµ∑ÂêÉÈ•≠ÔºåËÄå‰∏îÊúâÊó∂‰ºöÂØºËá¥Ëê•ÂÖª‰∏çË∂≥„ÄÇ)", vocabHint: "T·ª´ v·ª±ng c√≥ th·ªÉ s·ª≠ d·ª•ng (tham kh·∫£o trang 10 ):\nÊèèËø∞‰∏çÂêÉ‰ªÄ‰πà (M√¥ t·∫£ kh√¥ng ƒÉn g√¨): Ëæ£Ê§í, È£üÁâ©, ÂåÖÊã¨, ÂÜÖËÑè, ËÇâÈ£ü, È∏°Áà™Â≠ê, ÈªëÊöóÊñôÁêÜ, ÁÉ§È±º, Ëî¨Ëèú, ÊãíÁªù, È¶ôËèú, Âø´È§ê, ÂùöÊûú„ÄÇ\nËØ¥Êòé‰∏çÂêÉÁöÑÂéüÂõ† (Gi·∫£i th√≠ch l√Ω do kh√¥ng ƒÉn): Âèó‰∏ç‰∫Ü, Ê∏ÖÁúü, Á©ÜÊñØÊûó, ËøáÊïè, Ê≤πËÖª, Á¥†È£ü, ‰π≥Á≥ñ‰∏çËÄêÂèó, ÂÆÅÂèØ‚Ä¶‰πü‚Ä¶, ÂÜµ‰∏î„ÄÇ\nÂàÜÊûêËøôÁßçÈ•ÆÈ£üÂÅèÂ•ΩÂíå‰π†ÊÉØÂ∏¶Êù•ÁöÑÂ•ΩÂ§ÑÊàñÈóÆÈ¢ò (Ph√¢n t√≠ch l·ª£i √≠ch/v·∫•n ƒë·ªÅ): ÂØºËá¥, Ëê•ÂÖª‰∏çË∂≥, Ë∫´Êùê, ÂÖÖÊª°ÂäõÈáè, Áñ≤Âä≥, ‰∏•Èáç, ÈÄÇÂ∫¶„ÄÇ" };

        // ----- BI·∫æN TR·∫†NG TH√ÅI GAME -----
        let currentStage = 0; let gameStages = []; let totalQuestionsInGame = 0;
        let startTime; let timerInterval;
        let gameResults = { correct: 0, incorrect: 0, errors: [], totalTime: '00:00', sentenceCreations: [], sentenceCompletions: [] }; // Th√™m sentenceCompletions
        let playerName = "";
        // C√°c bi·∫øn ch·ªâ s·ªë kh√¥ng ƒë·ªïi: currentFillSentenceIndex, currentReadingQuestionIndex, currentSentenceCreationWordIndex
        // currentSentenceCompletionIndex kh√¥ng c√≤n c·∫ßn thi·∫øt v√¨ x·ª≠ l√Ω t·∫•t c·∫£ m·ªôt l·∫ßn
        let currentTargetWordForSC = null;

        // Bi·∫øn cho m√†n n·ªëi t·ª´ ki·ªÉu click-to-match
        let selectedWordElement = null;
        let matchedPairsCount = 0;


        // ----- GOOGLE FORM CONFIGURATION -----
        const GOOGLE_FORM_ACTION_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeBAu4nmQQX6F3wMeoEzwgCH-JFKT8e1wJ3u-yp4KANey39Fw/formResponse";
        const STUDENT_NAME_ENTRY_ID = "entry.497915687"; const TOTAL_TIME_ENTRY_ID = "entry.1644850563"; const CORRECT_COUNT_ENTRY_ID = "entry.1575464331"; const INCORRECT_COUNT_ENTRY_ID = "entry.1038973429"; const ERRORS_LIST_ENTRY_ID = "entry.888446367";
        // Entry ID cho c√°c c√¢u t·ª± lu·∫≠n (c√¥ c·∫ßn t·∫°o c√°c tr∆∞·ªùng n√†y trong Google Form v√† l·∫•y ID)
        // const SENTENCE_COMPLETIONS_ENTRY_ID = "entry.YYYYYYYYYY"; // V√≠ d·ª•
        // const SENTENCE_CREATIONS_ENTRY_ID = "entry.XXXXXXXXXX"; // V√≠ d·ª•

        // ----- DOM ELEMENTS -----
        const getEl = (id) => document.getElementById(id);
        const timerEl = () => getEl('timer'); const instructionsEl = () => getEl('instructions'); const gameAreaEl = () => getEl('game-area'); const hintButtonEl = () => getEl('hint-button'); const hintTextEl = () => getEl('hint-text'); const feedbackSectionEl = () => getEl('feedback-section'); const feedbackTextEl = () => getEl('feedback-text'); const nextStageButtonEl = () => getEl('next-stage-button'); const summaryPageEl = () => getEl('summary-page'); const gameContainerEl = () => getEl('game-container'); const tooltipEl = () => getEl('tooltip');

        // ----- FUNCTIONS -----

        // --- AI Integration (Google Gemini Flash) ---
        // H√†m callAI v·∫´n gi·ªØ nguy√™n, nh∆∞ng s·∫Ω kh√¥ng ƒë∆∞·ª£c g·ªçi t·ª´ m√†n ƒë·∫∑t c√¢u v√† ho√†n th√†nh c√¢u n·ªØa
        async function callAI(prompt) {
            const currentFeedbackEl = feedbackTextEl(); const currentFeedbackSectionEl = feedbackSectionEl();
            let purpose = "Unknown";
            const currentStageFunction = gameStages[currentStage -1];
            if (currentStageFunction) {
                 // Ch·ªâ d√πng AI cho ReadingComp v√† ParagraphWriting cho m·ª•c ƒë√≠ch ch·∫•m ƒëi·ªÉm
                 if (currentStageFunction.name.includes("ReadingComp") || currentStageFunction.name.includes("ParagraphWriting")) {
                     purpose = "Check Answer";
                 }
            }
            if (prompt.includes("t·∫°o m·ªôt g·ª£i √Ω")) { purpose = "Generate Hint"; }

            console.log(`--- G·ªçi AI (Gemini Flash) v·ªõi prompt (${purpose}) ---`); console.log(prompt);
            if (!currentFeedbackEl || !currentFeedbackSectionEl) { console.error("Feedback elements not found!"); return { isCorrect: false, explanation: "L·ªói giao di·ªán: Kh√¥ng t√¨m th·∫•y v√πng hi·ªÉn th·ªã ph·∫£n h·ªìi." }; }

            if (purpose !== 'Generate Hint') {
                currentFeedbackEl.textContent = "üß† AI ƒëang suy nghƒ©...";
                currentFeedbackSectionEl.className = 'info';
                currentFeedbackSectionEl.style.display = 'block';
            }

            const apiKey = 'AIzaSyBvdzFJAA8xSTMZ17nse19boON9zGopUyU'; // Thay b·∫±ng API key c·ªßa c√¥ n·∫øu c·∫ßn
            const modelName = 'gemini-1.5-flash-latest';
            const apiEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            const generationConfig = { temperature: 0.5, maxOutputTokens: 400 };
            const safetySettings = [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }, ];

            try {
                const response = await fetch(apiEndpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ contents: [{ parts: [{ "text": prompt }] }], generationConfig: generationConfig, safetySettings: safetySettings }), });
                if (!response.ok) { let errorData; try { errorData = await response.json(); console.error("L·ªói API (JSON):", errorData); } catch (e) { const errorText = await response.text(); console.error("L·ªói API (Text):", errorText); errorData = { error: { message: errorText || 'Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c l·ªói' } }; } const errorMessage = `L·ªói API ${response.status}: ${errorData?.error?.message || response.statusText || 'Kh√¥ng r√µ chi ti·∫øt'}.`; throw new Error(errorMessage); }
                const data = await response.json(); console.log(`Ph·∫£n h·ªìi t·ª´ ${modelName}:`, data);
                if (!data.candidates || data.candidates.length === 0 || !data.candidates[0].content || !data.candidates[0].content.parts || data.candidates[0].content.parts.length === 0) { const blockReason = data?.promptFeedback?.blockReason || "Kh√¥ng c√≥ ·ª©ng vi√™n tr·∫£ v·ªÅ"; const safetyRatings = data?.promptFeedback?.safetyRatings; console.error("AI Response Blocked/Empty:", blockReason, safetyRatings); throw new Error(`Ph·∫£n h·ªìi t·ª´ AI b·ªã ch·∫∑n ho·∫∑c tr·ªëng. L√Ω do: ${blockReason}.`); }
                const aiTextResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text || "AI kh√¥ng ƒë∆∞a ra ph·∫£n h·ªìi vƒÉn b·∫£n."; console.log("N·ªôi dung AI tr·∫£ v·ªÅ:", aiTextResponse);

                if (purpose === 'Generate Hint') { return { explanation: aiTextResponse }; }
                else {
                    let lowerResponse = aiTextResponse.toLowerCase(); let isCorrect = false;
                    const currentStageFuncName = currentStageFunction ? currentStageFunction.name : "";

                    if (currentStageFuncName.includes("ReadingComp") && (lowerResponse.startsWith("ƒë√°nh gi√°: ƒë√∫ng") || lowerResponse.startsWith("ƒë√°nh gi√° t·ªïng th·ªÉ: ƒë√∫ng"))) {
                        isCorrect = true;
                    } else if (currentStageFuncName.includes("ParagraphWriting") && !lowerResponse.includes("c·∫ßn c·∫£i thi·ªán nhi·ªÅu") && (lowerResponse.includes("t·ªët") || lowerResponse.includes("kh√°"))) {
                        isCorrect = true;
                    }

                    let explanation = aiTextResponse;
                     if (isCorrect && explanation.length > 150 && (explanation.includes("ph√¢n t√≠ch") || explanation.includes("gi·∫£i th√≠ch"))) { explanation = "ƒê√°nh gi√°: ƒê√∫ng. Ph√π h·ª£p."; }
                    else if (isCorrect && explanation.length > 150) { explanation = explanation.split('.')[0] + '.'; if(!explanation.toLowerCase().startsWith("ƒë√°nh gi√°")) { explanation = "ƒê√°nh gi√°: ƒê√∫ng. Ph√π h·ª£p.";} }
                    return { isCorrect, explanation };
                }
            } catch (error) {
                console.error(`L·ªói khi g·ªçi ${modelName} API:`, error);
                if (purpose === 'Generate Hint') { hintTextEl().textContent = "L·ªói: Kh√¥ng th·ªÉ t·∫°o g·ª£i √Ω t·ª´ AI."; hintButtonEl().disabled = false; return { explanation: "L·ªói t·∫°o g·ª£i √Ω." }; }
                else { currentFeedbackEl.textContent = error.message; currentFeedbackSectionEl.className = 'incorrect'; currentFeedbackSectionEl.style.display = 'block'; throw error; }
            }
        }

        // --- Timer Functions ---
        function startTimer() { startTime = Date.now(); if(timerInterval) clearInterval(timerInterval); timerInterval = setInterval(updateTimer, 1000); updateTimer(); }
        function updateTimer() { const currentTimerEl = timerEl(); if (!currentTimerEl) { if (timerInterval) clearInterval(timerInterval); return; } const elapsedTime = Math.floor((Date.now() - startTime) / 1000); const minutes = Math.floor(elapsedTime / 60).toString().padStart(2, '0'); const seconds = (elapsedTime % 60).toString().padStart(2, '0'); currentTimerEl.textContent = `${minutes}:${seconds}`; gameResults.totalTime = `${minutes}:${seconds}`; }
        function stopTimer() { if(timerInterval) clearInterval(timerInterval); timerInterval = null; }

        // --- UI and Feedback ---
        function setInstructions(htmlContentWithIcon) { const currentInstructionsEl = instructionsEl(); if (currentInstructionsEl) currentInstructionsEl.innerHTML = `<p>${htmlContentWithIcon}</p>`; }
        function showFeedback(isCorrectOrType, message) {
            const currentFeedbackSectionEl = feedbackSectionEl(); const currentFeedbackTextEl = feedbackTextEl();
            if (!currentFeedbackSectionEl || !currentFeedbackTextEl) return;
            currentFeedbackTextEl.textContent = message;
            if (isCorrectOrType === 'info') { currentFeedbackSectionEl.className = 'info'; }
            else { currentFeedbackSectionEl.className = isCorrectOrType ? 'correct' : 'incorrect'; }
            currentFeedbackSectionEl.style.display = 'block';
        }
        function recordResult(isCorrect, stageName, input, issue) { if (isCorrect) { gameResults.correct++; } else { gameResults.incorrect++; gameResults.errors.push({ stage: stageName, input: input || 'N/A', issue }); } console.log("Game Results Updated:", JSON.stringify(gameResults)); }
        function clearFeedback() { const currentFeedbackSectionEl = feedbackSectionEl(); const currentFeedbackTextEl = feedbackTextEl(); if (!currentFeedbackSectionEl || !currentFeedbackTextEl) return; currentFeedbackTextEl.textContent = ''; currentFeedbackSectionEl.style.display = 'none'; currentFeedbackSectionEl.className = ''; }
        async function showHint() { /* Gi·ªØ nguy√™n logic AI Hint, n·∫øu m√†n hi·ªán t·∫°i c√≥ h·ªó tr·ª£ */ }
        function clearHint() { const currentHintTextEl = hintTextEl(); if (currentHintTextEl) currentHintTextEl.textContent = ''; }
        function showTooltip(element, key) { /* Gi·ªØ nguy√™n */ }
        function hideTooltip() { /* Gi·ªØ nguy√™n */ }
        function hideTooltipOnClickOutside(event) { /* Gi·ªØ nguy√™n */ }
        async function submitResultsToGoogleForm() {
            const formData = new FormData();
            formData.append(STUDENT_NAME_ENTRY_ID, playerName || "·∫®n danh");
            formData.append(TOTAL_TIME_ENTRY_ID, gameResults.totalTime || "N/A");
            formData.append(CORRECT_COUNT_ENTRY_ID, gameResults.correct.toString());
            formData.append(INCORRECT_COUNT_ENTRY_ID, gameResults.incorrect.toString());

            let errorsText = gameResults.errors.map(err => `M√†n ${err.stage}: ${err.issue} (Input: ${err.input ? err.input.substring(0,100) : 'N/A'})`).join('\n');
            if (!errorsText) errorsText = "Kh√¥ng c√≥ l·ªói n√†o.";
            formData.append(ERRORS_LIST_ENTRY_ID, errorsText);

            // G·ª≠i c√°c c√¢u ho√†n th√†nh (n·∫øu c√¥ mu·ªën)
            // let sentenceCompletionsText = gameResults.sentenceCompletions.map((item, index) =>
            //    `${index+1}. B·∫Øt ƒë·∫ßu: "${item.starter}" - B·∫°n vi·∫øt: "${item.userInput}"`
            // ).join('\n\n');
            // if (!sentenceCompletionsText) sentenceCompletionsText = "Kh√¥ng c√≥ c√¢u ho√†n th√†nh n√†o.";
            // if (SENTENCE_COMPLETIONS_ENTRY_ID) { // Ch·ªâ g·ª≠i n·∫øu c√≥ Entry ID
            //     formData.append(SENTENCE_COMPLETIONS_ENTRY_ID, sentenceCompletionsText);
            // }

            // G·ª≠i c√°c c√¢u ƒë·∫∑t (n·∫øu c√¥ mu·ªën)
            // let sentencesCreatedText = gameResults.sentenceCreations.map((item, index) =>
            //    `${index+1}. T·ª´: ${item.word} (${item.pinyin}) - C√¢u: ${item.sentence}`
            // ).join('\n\n');
            // if (!sentencesCreatedText) sentencesCreatedText = "Kh√¥ng c√≥ c√¢u n√†o ƒë∆∞·ª£c ƒë·∫∑t.";
            // if (SENTENCE_CREATIONS_ENTRY_ID) { // Ch·ªâ g·ª≠i n·∫øu c√≥ Entry ID
            //     formData.append(SENTENCE_CREATIONS_ENTRY_ID, sentencesCreatedText);
            // }

            try {
                const submitButton = getEl('submit-report-button');
                submitButton.disabled = true;
                submitButton.textContent = "ƒêang g·ª≠i...";
                await fetch(GOOGLE_FORM_ACTION_URL, { method: 'POST', body: formData, mode: 'no-cors' });
                console.log('ƒê√£ g·ª≠i (ho·∫∑c c·ªë g·∫Øng g·ª≠i) b√°o c√°o l√™n Google Form.');
                alert('ƒê√£ g·ª≠i b√°o c√°o th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ tham gia!');
                submitButton.textContent = "ƒê√£ G·ª≠i ‚úîÔ∏è";
                submitButton.style.backgroundColor = '#198754';
            } catch (error) {
                console.error('L·ªói khi g·ª≠i b√°o c√°o:', error);
                alert('C√≥ l·ªói x·∫£y ra khi g·ª≠i b√°o c√°o. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c b√°o cho gi√°o vi√™n.');
                const submitButton = getEl('submit-report-button');
                submitButton.disabled = false;
                submitButton.textContent = "N·ªôp B√°o C√°o L√™n Google Form üìã";
            }
        }


        // ----- QU·∫¢N L√ù M√ÄN CH∆†I -----
        function loadNextStage() {
            currentStage++;
            clearFeedback(); clearHint();
            selectedWordElement = null; matchedPairsCount = 0;

            const nextBtn = nextStageButtonEl();
            if(nextBtn) nextBtn.classList.add('hidden');

            if (currentStage <= gameStages.length) {
                const stageLoaderFunction = gameStages[currentStage - 1];
                console.log(`Loading stage ${currentStage}: ${stageLoaderFunction.name}`);
                stageLoaderFunction();
                const currentStageName = stageLoaderFunction.name;
                // Ch·ªâ hi·ªÉn th·ªã n√∫t hint cho c√°c m√†n c√≤n d√πng AI ch·∫•m ho·∫∑c c√≥ c·∫•u tr√∫c g·ª£i √Ω ph·ª©c t·∫°p
                if (currentStageName === "loadReadingCompStage" || currentStageName === "loadParagraphWritingStage") {
                    hintButtonEl()?.classList.remove('hidden');
                } else {
                    hintButtonEl()?.classList.add('hidden');
                }
            } else {
                console.log("All stages completed. Showing summary.");
                showSummary();
                hintButtonEl()?.classList.add('hidden');
            }
        }

        // ----- C√ÅC H√ÄM LOAD M√ÄN CH∆†I -----

        function loadVocabMatchingStage() {
            setInstructions("ü§ù M√†n 1.1: N·ªëi T·ª´. Nh·∫•p v√†o m·ªôt t·ª´ ti·∫øng Trung, sau ƒë√≥ nh·∫•p v√†o nghƒ©a ti·∫øng Vi·ªát t∆∞∆°ng ·ª©ng ƒë·ªÉ gh√©p c·∫∑p.");
            const gameArea = gameAreaEl();
            hintButtonEl()?.classList.add('hidden');
            selectedWordElement = null; matchedPairsCount = 0;

            const wordsData = [...vocabMatchingData]; const meaningsData = [...vocabMatchingData];
            shuffleArray(wordsData); shuffleArray(meaningsData);

            let wordHTML = wordsData.map(item => `<div class="selectable-word" data-id="${item.id}">${item.hanzi} (${item.pinyin})</div>`).join('');
            let meaningHTML = meaningsData.map(item => `<div class="selectable-meaning" data-target-id="${item.id}" data-meaning-text="${item.meaning}">${item.meaning}</div>`).join('');

            gameArea.innerHTML = ` <h3 class="stage-title">B√†i 1.1: N·ªëi T·ª´ V·ªõi Nghƒ©a</h3> <div id="vocab-matching-area"> <div class="vocab-columns-container"> <div class="vocab-list-column" id="word-source-column">${wordHTML}</div> <div class="meaning-list-column" id="meaning-target-column">${meaningHTML}</div> </div> </div> `;

            if (gameStages[currentStage-1].name === "loadVocabMatchingStage" && !gameArea.dataset.questionsCounted_vocabMatching) { // S·ª≠ d·ª•ng data-attribute ri√™ng
                totalQuestionsInGame += vocabMatchingData.length;
                gameArea.dataset.questionsCounted_vocabMatching = 'true';
            }
            addVocabSelectionListeners();
        }

        function addVocabSelectionListeners() {
            const wordElements = document.querySelectorAll('.selectable-word');
            const meaningElements = document.querySelectorAll('.selectable-meaning');

            wordElements.forEach(wordEl => {
                wordEl.addEventListener('click', () => {
                    if (wordEl.classList.contains('matched')) return;
                    if (selectedWordElement) selectedWordElement.classList.remove('selected');
                    selectedWordElement = wordEl; selectedWordElement.classList.add('selected');
                    clearFeedback();
                });
            });

            meaningElements.forEach(meaningEl => {
                meaningEl.addEventListener('click', () => {
                    if (meaningEl.classList.contains('matched') || !selectedWordElement) {
                        if (!selectedWordElement && !meaningEl.classList.contains('matched')) showFeedback('info', "üí° B·∫°n c·∫ßn ch·ªçn m·ªôt t·ª´ ti·∫øng Trung tr∆∞·ªõc.");
                        return;
                    }
                    const wordId = selectedWordElement.dataset.id;
                    const meaningId = meaningEl.dataset.targetId;
                    if (wordId === meaningId) {
                        selectedWordElement.classList.add('matched'); selectedWordElement.classList.remove('selected');
                        meaningEl.classList.add('matched', 'correct');
                        const originalWordObject = vocabMatchingData.find(item => item.id.toString() === wordId);
                        meaningEl.innerHTML = `<span class="placed-word">${originalWordObject.hanzi} (${originalWordObject.pinyin})</span><br>${originalWordObject.meaning}`;
                        meaningEl.style.pointerEvents = 'none'; selectedWordElement.style.pointerEvents = 'none';
                        matchedPairsCount++; selectedWordElement = null; clearFeedback();
                        if (matchedPairsCount === vocabMatchingData.length) {
                            // Kh√¥ng g·ªçi recordResult ·ªü ƒë√¢y v√¨ ƒë√£ t√≠nh 1 l·∫ßn ·ªü checkVocabMatching (n·∫øu gi·ªØ n√∫t) ho·∫∑c s·∫Ω t√≠nh ·ªü cu·ªëi m√†n
                            // Tuy nhi√™n, v·ªõi logic m·ªõi, ch√∫ng ta s·∫Ω record ngay khi ho√†n th√†nh
                            if (!getEl('game-area').dataset.recorded_vocabMatching) { // ƒê·∫£m b·∫£o ch·ªâ record 1 l·∫ßn
                                recordResult(true, "N·ªëi t·ª´ B√†i 1.1", `Ho√†n th√†nh ${matchedPairsCount}/${vocabMatchingData.length}`, "");
                                getEl('game-area').dataset.recorded_vocabMatching = 'true';
                            }
                            showFeedback(true, `üéâ Tuy·ªát v·ªùi! B·∫°n ƒë√£ n·ªëi ƒë√∫ng t·∫•t c·∫£ ${vocabMatchingData.length} c·∫∑p t·ª´.`);
                            nextStageButtonEl()?.classList.remove('hidden');
                        }
                    } else {
                        showFeedback(false, "Ch∆∞a ƒë√∫ng r·ªìi! H√£y th·ª≠ l·∫°i c·∫∑p kh√°c nh√©.");
                        if (selectedWordElement) { selectedWordElement.classList.remove('selected'); selectedWordElement = null; }
                    }
                });
            });
        }
        // checkVocabMatching kh√¥ng c√≤n th·ª±c s·ª± c·∫ßn thi·∫øt n·ªØa.
        function checkVocabMatching() {}


        function loadVocabFillStage() { setInstructions("‚úçÔ∏è M√†n 1.2: Ch·ªçn T·ª´. Ch·ªçn t·ª´ th√≠ch h·ª£p t·ª´ danh s√°ch ƒë·ªÉ ƒëi·ªÅn v√†o ch·ªó tr·ªëng."); const gameArea = gameAreaEl(); hintButtonEl()?.classList.add('hidden'); let sentencesHTML = vocabFillData.sentences.map((sentenceData, index) => { let sentenceHTML = `<div class="fill-sentence" id="vf_sentence_${index + 1}">`; sentenceData.parts.forEach(part => { if (typeof part === 'string') { sentenceHTML += `<span>${part}</span>`; } else { sentenceHTML += `<select id="${part.placeholderID}">`; sentenceHTML += `<option value="">---Ch·ªçn---</option>`; vocabFillData.options.forEach(opt => { sentenceHTML += `<option value="${opt}">${opt}</option>`; }); sentenceHTML += `</select>`; } }); sentenceHTML += `</div>`; return sentenceHTML; }).join(''); gameArea.innerHTML = ` <h3 class="stage-title">B√†i 1.2: Ch·ªçn T·ª´ Th√≠ch H·ª£p</h3> <p><strong>T·ª´ ƒë·ªÉ ch·ªçn:</strong> ${vocabFillData.options.join(', ')}</p> ${sentencesHTML} <button id="check-vocab-fill">Ki·ªÉm Tra ƒêi·ªÅn T·ª´</button> `; getEl('check-vocab-fill').addEventListener('click', checkVocabFill); }
        function checkVocabFill() { let correctCount = 0; let totalBlanksInThisStage = 0; const feedbackMessages = []; vocabFillData.sentences.forEach((sentenceData, sentenceIndex) => { sentenceData.parts.forEach(part => { if (typeof part !== 'string') { totalBlanksInThisStage++; const selectedValue = getEl(part.placeholderID).value; if (selectedValue === part.answer) { correctCount++; getEl(part.placeholderID).style.borderColor = 'green'; } else { getEl(part.placeholderID).style.borderColor = 'red'; feedbackMessages.push(`C√¢u ${sentenceIndex + 1}, ch·ªó tr·ªëng "${part.answer}" ch·ªçn sai.`); } } }); }); if(gameStages[currentStage-1].name === "loadVocabFillStage" && !getEl('check-vocab-fill').dataset.counted_vocabFill) { totalQuestionsInGame += totalBlanksInThisStage; getEl('check-vocab-fill').dataset.counted_vocabFill = 'true';} recordResult(correctCount === totalBlanksInThisStage, "ƒêi·ªÅn t·ª´ B√†i 1.2", `ƒê√∫ng ${correctCount}/${totalBlanksInThisStage}`, correctCount === totalBlanksInThisStage ? "" : feedbackMessages.join(" ")); showFeedback(correctCount === totalBlanksInThisStage, `B·∫°n ƒë√£ ƒëi·ªÅn ƒë√∫ng ${correctCount} / ${totalBlanksInThisStage} ch·ªó tr·ªëng. ${correctCount !== totalBlanksInThisStage ? 'H√£y xem l·∫°i c√°c ch·ªó b√¥i ƒë·ªè.' : ''}`); if (correctCount === totalBlanksInThisStage) { nextStageButtonEl()?.classList.remove('hidden'); getEl('check-vocab-fill').disabled = true; } else { getEl('check-vocab-fill').disabled = false;} }

        // ---- M√ÄN 2.1: HO√ÄN TH√ÄNH C√ÇU (L∆ØU ƒê·ªÇ GI√ÅO VI√äN CH·∫§M) ----
        function loadSentenceCompletionStage() {
            setInstructions("üìù M√†n 2.1: Ho√†n Th√†nh C√¢u. S·ª≠ d·ª•ng c√°c c·∫•u tr√∫c ƒë√£ h·ªçc ƒë·ªÉ vi·∫øt ti·∫øp c√¢u. C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c gi√°o vi√™n xem v√† ch·∫•m sau.");
            const gameArea = gameAreaEl();
            hintButtonEl()?.classList.add('hidden'); // ·∫®n n√∫t g·ª£i √Ω AI cho m√†n n√†y

            // Kh√¥ng c·ªông v√†o totalQuestionsInGame v√¨ kh√¥ng ch·∫•m t·ª± ƒë·ªông
            // if(gameStages[currentStage-1].name === "loadSentenceCompletionStage" && !gameArea.dataset.questionsCounted_sc) {
            //     totalQuestionsInGame += sentenceCompletionData.length;
            //     gameArea.dataset.questionsCounted_sc = 'true';
            // }

            let itemsHTML = sentenceCompletionData.map((item, index) => `
                <div class="sentence-completion-item">
                    <label for="sc_input_${item.id}">
                        ${index + 1}. ${item.starter}
                        <input type="text" id="sc_input_${item.id}" placeholder="Vi·∫øt ti·∫øp v√†o ƒë√¢y...">
                        ${item.exampleSuffix || ''}
                    </label>
                </div>
            `).join('');

            gameArea.innerHTML = `
                <h3 class="stage-title">B√†i 2.1: Ho√†n Th√†nh C√¢u</h3>
                ${itemsHTML}
                <button id="save-sentence-completions-button">L∆∞u C√°c C√¢u Tr·∫£ L·ªùi</button>
            `;
            getEl('save-sentence-completions-button').addEventListener('click', saveAllSentenceCompletions);
        }

        function saveAllSentenceCompletions() {
            const saveButton = getEl('save-sentence-completions-button');
            saveButton.disabled = true;
            saveButton.textContent = "ƒêang l∆∞u...";
            clearFeedback();
            gameResults.sentenceCompletions = []; // X√≥a c√°c c√¢u ƒë√£ l∆∞u tr∆∞·ªõc ƒë√≥ n·∫øu c√≥ (ph√≤ng tr∆∞·ªùng h·ª£p quay l·∫°i m√†n)

            let allFilled = true;
            for (let i = 0; i < sentenceCompletionData.length; i++) {
                const item = sentenceCompletionData[i];
                const userInputEl = getEl(`sc_input_${item.id}`);
                const userInput = userInputEl.value.trim();
                const fullSentenceAttempt = item.starter + userInput;

                if (!userInput) {
                    userInputEl.style.borderColor = 'red';
                    allFilled = false;
                } else {
                    userInputEl.style.borderColor = 'grey'; // Reset border color
                     gameResults.sentenceCompletions.push({
                        id: item.id,
                        starter: item.starter,
                        userInput: userInput,
                        fullSentence: fullSentenceAttempt,
                        exampleSuffix: item.exampleSuffix || ""
                    });
                }
            }

            if (!allFilled) {
                showFeedback(false, "Vui l√≤ng ho√†n th√†nh t·∫•t c·∫£ c√°c c√¢u tr∆∞·ªõc khi l∆∞u.");
                saveButton.disabled = false;
                saveButton.textContent = "L∆∞u C√°c C√¢u Tr·∫£ L·ªùi";
                return;
            }

            console.log("C√°c c√¢u ho√†n th√†nh ƒë√£ l∆∞u:", gameResults.sentenceCompletions);
            showFeedback('info', "T·∫•t c·∫£ c√°c c√¢u ho√†n th√†nh c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c l∆∞u l·∫°i ƒë·ªÉ gi√°o vi√™n xem x√©t.");
            nextStageButtonEl()?.classList.remove('hidden');
            saveButton.textContent = "ƒê√£ L∆∞u ‚úîÔ∏è";
            // Kh√¥ng g·ªçi recordResult ·ªü ƒë√¢y
        }


        function loadReadingCompStage() {
            setInstructions("üìñ M√†n 3.1: ƒê·ªçc Hi·ªÉu. ƒê·ªçc ƒëo·∫°n vƒÉn v√† tr·∫£ l·ªùi c√¢u h·ªèi.");
            const gameArea = gameAreaEl();
            hintButtonEl()?.classList.remove('hidden'); // Cho ph√©p hint cho ƒë·ªçc hi·ªÉu
            if(gameStages.find(stage => stage.name === "loadReadingCompStage") && !gameArea.dataset.questionsCounted_rc) {
                totalQuestionsInGame += readingCompData.questions.length;
                gameArea.dataset.questionsCounted_rc = 'true';
            }

            const passage = readingCompData.passage;
            const lines = passage.split('\n');
            let formattedPassageHTML = '';
            const characterColors = { 'Âº†Â∞èËñá': '#007bff', 'Êú¥Êô∫ÊÖß': '#28a745', 'Â±±‰∏ãÂíå‰πü': '#fd7e14', 'ÂÜØÂ∞öÂæ∑': '#6f42c1', 'ÈôàÊñ∞Èò≥': '#d63384', 'Â±±‰∏ãÂíå‰πü„ÄÅÈôàÊñ∞Èò≥„ÄÅÂÜØÂ∞öÂæ∑„ÄÅÊú¥Êô∫ÊÖß': '#6610f2' };

            lines.forEach(line => {
                if (line.trim() === '') return;
                let speaker = null; let speech = line;
                for (const charName in characterColors) { if (line.startsWith(charName + ":")) { speaker = charName; speech = line.substring(charName.length + 1).trim(); break; } }
                if (speaker) { const color = characterColors[speaker] || '#343a40'; formattedPassageHTML += `<p class="speaker-line" style="margin-bottom: 0.8em;"><strong style="color: ${color};">${speaker}:</strong> <span style="color: ${color};">${speech}</span></p>`; }
                else if (line.startsWith('(') && line.endsWith(')')) { formattedPassageHTML += `<p class="reading-narrative" style="margin-bottom: 0.8em;">${line}</p>`; }
                else { const multiSpeakerKey = 'Â±±‰∏ãÂíå‰πü„ÄÅÈôàÊñ∞Èò≥„ÄÅÂÜØÂ∞öÂæ∑„ÄÅÊú¥Êô∫ÊÖß'; if (line.startsWith(multiSpeakerKey + ":")) { speaker = multiSpeakerKey; speech = line.substring(multiSpeakerKey.length + 1).trim(); const color = characterColors[speaker] || '#343a40'; formattedPassageHTML += `<p class="speaker-line" style="margin-bottom: 0.8em;"><strong style="color: ${color};">${speaker}:</strong> <span style="color: ${color};">${speech}</span></p>`; } else { formattedPassageHTML += `<p style="margin-bottom: 0.8em;">${line}</p>`; } }
            });
            let questionsHTML = readingCompData.questions.map((q, index) => ` <div class="reading-question"> <label for="rc_input_${q.id}">${index + 1}. ${q.text}</label> <textarea id="rc_input_${q.id}" rows="3"></textarea> </div> `).join('');
            gameArea.innerHTML = ` <h3 class="stage-title">B√†i 3.1: ƒê·ªçc Hi·ªÉu</h3> <div id="reading-passage">${formattedPassageHTML}</div> ${questionsHTML} <button id="check-reading-comp">Ki·ªÉm Tra ƒê·ªçc Hi·ªÉu (AI)</button> `;
            getEl('check-reading-comp').addEventListener('click', checkAllReadingComp);
        }
        async function checkAllReadingComp() { const submitButton = getEl('check-reading-comp'); submitButton.disabled = true; submitButton.textContent = "AI ƒëang ki·ªÉm tra..."; clearFeedback(); let allCorrectThisCheck = true; let stageFeedback = []; for (let i = 0; i < readingCompData.questions.length; i++) { const q = readingCompData.questions[i]; const userInputEl = getEl(`rc_input_${q.id}`); const userAnswer = userInputEl.value.trim(); if (!userAnswer) { userInputEl.style.borderColor = 'red'; allCorrectThisCheck = false; recordResult(false, `ƒê·ªçc hi·ªÉu Q${i+1}`, "Ch∆∞a nh·∫≠p", "Ch∆∞a tr·∫£ l·ªùi c√¢u h·ªèi."); stageFeedback.push(`C√¢u ${i+1}: B·∫°n ch∆∞a tr·∫£ l·ªùi c√¢u h·ªèi.`); } else { const prompt = `D·ª±a v√†o ƒëo·∫°n vƒÉn sau: "${readingCompData.passage}".\nC√¢u h·ªèi l√†: "${q.text}".\nH·ªçc sinh tr·∫£ l·ªùi: "${userAnswer}".\nC√¢u tr·∫£ l·ªùi c√≥ ƒë√∫ng v√† d·ª±a tr√™n n·ªôi dung ƒëo·∫°n vƒÉn kh√¥ng? C√≥ s·ª≠ d·ª•ng ƒë√∫ng c√°c t·ª´ kh√≥a ƒë∆∞·ª£c y√™u c·∫ßu (${q.keywords.join(', ')}) kh√¥ng (n·∫øu c√°c t·ª´ kh√≥a ƒë√≥ ph√π h·ª£p)? ƒê√°nh gi√° b·∫Øt ƒë·∫ßu b·∫±ng "ƒê√°nh gi√°: [ƒê√∫ng/Sai]" v√† gi·∫£i th√≠ch NG·∫ÆN G·ªåN n·∫øu sai.`; try { const aiResult = await callAI(prompt); recordResult(aiResult.isCorrect, `ƒê·ªçc hi·ªÉu Q${i+1}`, userAnswer, aiResult.isCorrect ? "" : aiResult.explanation); if (!aiResult.isCorrect) { allCorrectThisCheck = false; userInputEl.style.borderColor = 'red'; } else { userInputEl.style.borderColor = 'green'; } stageFeedback.push(`C√¢u ${i+1}: ${aiResult.explanation}`); } catch (error) { allCorrectThisCheck = false; recordResult(false, `ƒê·ªçc hi·ªÉu Q${i+1}`, userAnswer, `L·ªói API: ${error.message}`); stageFeedback.push(`C√¢u ${i+1}: L·ªói khi ki·ªÉm tra v·ªõi AI.`); userInputEl.style.borderColor = 'orange'; } } } showFeedback(allCorrectThisCheck, stageFeedback.join("\n\n")); submitButton.disabled = false; submitButton.textContent = "Ki·ªÉm Tra ƒê·ªçc Hi·ªÉu (AI)"; if (allCorrectThisCheck) { nextStageButtonEl()?.classList.remove('hidden'); submitButton.disabled = true; } }

        function loadSentenceCreationStage() {
            setInstructions("üí¨ M√†n 4.1: ƒê·∫∑t C√¢u. H√£y ƒë·∫∑t m·ªôt c√¢u ti·∫øng Trung ho√†n ch·ªânh s·ª≠ d·ª•ng t·ª´ cho s·∫µn. C√¢u c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c gi√°o vi√™n xem v√† ch·∫•m sau.");
            const gameArea = gameAreaEl();
            hintButtonEl()?.classList.add('hidden');
            currentSentenceCreationWordIndex = 0;
            displayCurrentSCWord();
        }
        function displayCurrentSCWord() {
            const gameArea = gameAreaEl();
            if (sentenceCreationWordsNew && currentSentenceCreationWordIndex < sentenceCreationWordsNew.length) {
                currentTargetWordForSC = sentenceCreationWordsNew[currentSentenceCreationWordIndex];
                gameArea.innerHTML = ` <h3 class="stage-title">B√†i 4.1: ƒê·∫∑t C√¢u (${currentSentenceCreationWordIndex + 1}/${sentenceCreationWordsNew.length})</h3> <div id="sc-current-word-area"> <p><strong>H√£y ƒë·∫∑t c√¢u v·ªõi t·ª´:</strong></p> <span id="sc-current-word-hanzi">${currentTargetWordForSC.hanzi}</span> <span id="sc-current-word-pinyin">(${currentTargetWordForSC.pinyin})</span> <span id="sc-current-word-meaning">${currentTargetWordForSC.meaning}</span> </div> <textarea id="sc-sentence-input" rows="4" placeholder="Vi·∫øt c√¢u c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea> <button id="submit-sc-sentence">L∆∞u C√¢u</button> `;
                getEl('submit-sc-sentence').addEventListener('click', handleSubmitSCCurrentSentence);
                clearFeedback(); clearHint(); nextStageButtonEl()?.classList.add('hidden');
            } else { console.log("Ho√†n th√†nh M√†n 4.1 ƒê·∫∑t C√¢u."); loadNextStage(); }
        }
        async function handleSubmitSCCurrentSentence() {
            const sentenceInput = getEl('sc-sentence-input'); const sentence = sentenceInput ? sentenceInput.value.trim() : '';
            if (!currentTargetWordForSC) { showFeedback(false, "L·ªói: Kh√¥ng c√≥ t·ª´ m·ª•c ti√™u."); return; }
            if (!sentence) { showFeedback(false, "B·∫°n ch∆∞a nh·∫≠p c√¢u!"); return; }
            const submitButton = getEl('submit-sc-sentence'); submitButton.disabled = true; submitButton.textContent = "ƒêang l∆∞u...";
            const userSentenceEntry = { word: currentTargetWordForSC.hanzi, pinyin: currentTargetWordForSC.pinyin, meaning: currentTargetWordForSC.meaning, sentence: sentence };
            gameResults.sentenceCreations.push(userSentenceEntry); console.log("C√¢u ƒë√£ l∆∞u:", userSentenceEntry);
            showFeedback('info', `C√¢u c·ªßa b·∫°n v·ªõi t·ª´ "${currentTargetWordForSC.hanzi}" ƒë√£ ƒë∆∞·ª£c l∆∞u l·∫°i.`);
            currentSentenceCreationWordIndex++; setTimeout(() => { displayCurrentSCWord(); }, 1500);
        }


        function loadParagraphWritingStage() { setInstructions("‚úçÔ∏è M√†n 5.1: Vi·∫øt ƒêo·∫°n VƒÉn. H√£y vi·∫øt v·ªÅ s·ªü th√≠ch ƒÉn u·ªëng c·ªßa b·∫°n."); const gameArea = gameAreaEl(); hintButtonEl()?.classList.remove('hidden'); if(gameStages.find(stage => stage.name === "loadParagraphWritingStage") && !gameArea.dataset.questionsCounted_pw) {totalQuestionsInGame++; gameArea.dataset.questionsCounted_pw = 'true';} gameArea.innerHTML = ` <h3 class="stage-title">B√†i 5.1: ${paragraphWritingData.title}</h3> <div id="paragraph-writing-prompt"> <p>${paragraphWritingData.instructions.replace(/\n/g, '<br>')}</p> <h4>C·∫•u tr√∫c g·ª£i √Ω:</h4> <p>${paragraphWritingData.structureHint.replace(/\n/g, '<br>')}</p> <h4>T·ª´ v·ª±ng c√≥ th·ªÉ s·ª≠ d·ª•ng:</h4> <p>${paragraphWritingData.vocabHint.replace(/\n/g, '<br>')}</p> </div> <textarea id="paragraph-input" placeholder="Vi·∫øt ƒëo·∫°n vƒÉn c·ªßa b·∫°n v√†o ƒë√¢y (kho·∫£ng 100-150 ch·ªØ)..."></textarea> <div id="char-count">0/150 ch·ªØ</div> <button id="check-paragraph-writing">Ki·ªÉm Tra ƒêo·∫°n VƒÉn (AI)</button> `; const paragraphInputEl = getEl('paragraph-input'); const charCountEl = getEl('char-count'); paragraphInputEl.addEventListener('input', () => { const charLength = paragraphInputEl.value.length; charCountEl.textContent = `${charLength}/150 ch·ªØ`; if (charLength > 170) { charCountEl.style.color = 'red'; } else { charCountEl.style.color = '#6c757d'; } }); getEl('check-paragraph-writing').addEventListener('click', checkParagraphWriting); }
        async function checkParagraphWriting() { const paragraphInput = getEl('paragraph-input').value.trim(); if (paragraphInput.length < 80) { showFeedback(false, "ƒêo·∫°n vƒÉn c·ªßa b·∫°n h∆°i ng·∫Øn, h√£y vi·∫øt th√™m nh√© (√≠t nh·∫•t 80 ch·ªØ)."); return; } const submitButton = getEl('check-paragraph-writing'); submitButton.disabled = true; submitButton.textContent = "AI ƒëang ki·ªÉm tra..."; clearFeedback(); const prompt = `ƒê√°nh gi√° ƒëo·∫°n vƒÉn sau c·ªßa h·ªçc sinh vi·∫øt v·ªÅ ch·ªß ƒë·ªÅ '${paragraphWritingData.title}', y√™u c·∫ßu kho·∫£ng 100-150 ch·ªØ. ƒêo·∫°n vƒÉn: "${paragraphInput}". ƒê√°nh gi√° v·ªÅ s·ª± m·∫°ch l·∫°c, ng·ªØ ph√°p, t·ª´ v·ª±ng (c√≥ s·ª≠ d·ª•ng t·ª´ g·ª£i √Ω kh√¥ng?), v√† t√≠nh ph√π h·ª£p v·ªõi ch·ªß ƒë·ªÅ. Tr·∫£ l·ªùi b·∫Øt ƒë·∫ßu b·∫±ng "ƒê√°nh gi√°: [T·ªët/Kh√°/C·∫ßn c·∫£i thi·ªán]". Sau ƒë√≥ ƒë∆∞a ra nh·∫≠n x√©t t·ªïng quan v√† 2-3 g·ª£i √Ω c·∫£i thi·ªán NG·∫ÆN G·ªåN.`; try { const aiResult = await callAI(prompt); let isPass = !aiResult.explanation.toLowerCase().includes("c·∫ßn c·∫£i thi·ªán nhi·ªÅu"); recordResult(isPass, "Vi·∫øt ƒëo·∫°n B√†i 5.1", paragraphInput.substring(0,50)+"...", isPass ? "" : aiResult.explanation); showFeedback(isPass, aiResult.explanation); if (isPass) { nextStageButtonEl()?.classList.remove('hidden'); submitButton.disabled = true; } else { submitButton.disabled = false; submitButton.textContent = "Ki·ªÉm Tra ƒêo·∫°n VƒÉn (AI)"; } } catch (error) { showFeedback(false, `L·ªói API: ${error.message}`); submitButton.disabled = false; submitButton.textContent = "Ki·ªÉm Tra ƒêo·∫°n VƒÉn (AI)"; } }

        // ----- Summary Page -----
        function showSummary() {
            stopTimer();
            const currentgameContainerEl = gameContainerEl(); const currentsummaryPageEl = summaryPageEl();
            if (!currentgameContainerEl || !currentsummaryPageEl) return;

            currentgameContainerEl.classList.add('hidden');
            currentsummaryPageEl.style.display = 'block'; currentsummaryPageEl.classList.remove('hidden');

            getEl('summary-player-name').textContent = playerName || "·∫®n danh";
            getEl('summary-time').textContent = gameResults.totalTime || 'N/A';
            getEl('summary-correct').textContent = gameResults.correct || 0;
            getEl('total-questions-summary').textContent = totalQuestionsInGame || 0;
            getEl('summary-incorrect').textContent = gameResults.incorrect || 0;

            const errorsListEl = getEl('summary-errors');
            if(errorsListEl) {
                errorsListEl.innerHTML = '';
                if (gameResults.errors && gameResults.errors.length > 0) {
                    gameResults.errors.forEach(err => {
                        const li = document.createElement('li');
                        const shortInput = err.input && err.input.length > 100 ? err.input.substring(0, 97) + '...' : err.input;
                        li.innerHTML = `<strong>M√†n ${err.stage}:</strong> ${err.issue} <br><small>(Input: ${shortInput || 'N/A'})</small>`;
                        errorsListEl.appendChild(li);
                    });
                } else { errorsListEl.innerHTML = '<li>Ch√∫c m·ª´ng! B·∫°n kh√¥ng m·∫Øc l·ªói n√†o ·ªü c√°c ph·∫ßn c√≥ ch·∫•m ƒëi·ªÉm t·ª± ƒë·ªông! ‚ú®</li>'; }
            }

            // Hi·ªÉn th·ªã c√°c c√¢u ƒë√£ ho√†n th√†nh (Sentence Completion)
            const sentenceCompletionsListEl = getEl('summary-sentence-completions');
            if (sentenceCompletionsListEl) {
                sentenceCompletionsListEl.innerHTML = '';
                if (gameResults.sentenceCompletions && gameResults.sentenceCompletions.length > 0) {
                    gameResults.sentenceCompletions.forEach((entry, index) => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>C√¢u g·ªëc ${index + 1}:</strong> ${entry.starter} <em>${entry.userInput}</em> ${entry.exampleSuffix}<br><small>(To√†n b·ªô c√¢u b·∫°n vi·∫øt: ${entry.fullSentence})</small>`;
                        sentenceCompletionsListEl.appendChild(li);
                    });
                } else { sentenceCompletionsListEl.innerHTML = '<li>(Kh√¥ng c√≥ c√¢u tr·∫£ l·ªùi n√†o ƒë∆∞·ª£c l∆∞u cho ph·∫ßn ho√†n th√†nh c√¢u)</li>'; }
            }

            const sentenceCreationsListEl = getEl('summary-sentence-creations');
            if (sentenceCreationsListEl) {
                sentenceCreationsListEl.innerHTML = '';
                if (gameResults.sentenceCreations && gameResults.sentenceCreations.length > 0) {
                    gameResults.sentenceCreations.forEach((entry, index) => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>T·ª´: ${entry.word}</strong> (${entry.pinyin} - <em>${entry.meaning}</em>)<br>C√¢u b·∫°n ƒë·∫∑t: <em>${entry.sentence}</em>`;
                        sentenceCreationsListEl.appendChild(li);
                    });
                } else { sentenceCreationsListEl.innerHTML = '<li>(Kh√¥ng c√≥ c√¢u tr·∫£ l·ªùi n√†o ƒë∆∞·ª£c l∆∞u cho ph·∫ßn ƒë·∫∑t c√¢u)</li>'; }
            }

            const submitReportButton = getEl('submit-report-button');
            if (submitReportButton) { submitReportButton.disabled = false; submitReportButton.textContent = "N·ªôp B√°o C√°o L√™n Google Form üìã"; submitReportButton.style.backgroundColor = '#28a745'; submitReportButton.onclick = submitResultsToGoogleForm; }
            const restartButton = getEl('restart-button');
            if (restartButton && !restartButton.dataset.listenerAttached) { restartButton.addEventListener('click', initGame); restartButton.dataset.listenerAttached = 'true'; }
        }

        // ----- Initialization -----
        function initGame() {
            console.log("Initializing new game: Êàë‰∏çÂêÉËøô‰∏™ (Manual SC & Creation)");
            gameStages = [
                loadVocabMatchingStage, loadVocabFillStage, loadSentenceCompletionStage,
                loadReadingCompStage, loadSentenceCreationStage, loadParagraphWritingStage
            ];
            currentStage = 0; totalQuestionsInGame = 0;
            gameResults = { correct: 0, incorrect: 0, errors: [], totalTime: '00:00', sentenceCreations: [], sentenceCompletions: [] };
            playerName = ""; selectedWordElement = null; matchedPairsCount = 0;

            if (timerInterval) clearInterval(timerInterval); timerInterval = null;
            const currentTimerEl = timerEl(); if(currentTimerEl) currentTimerEl.textContent = '00:00';
            const currentgameContainerEl = gameContainerEl(); const currentsummaryPageEl = summaryPageEl(); const currentgameAreaEl = gameAreaEl(); const currentNextStageButtonEl = nextStageButtonEl(); const currentInstructionsEl = instructionsEl();

            if(currentgameContainerEl) currentgameContainerEl.classList.remove('hidden');
            if(currentsummaryPageEl) currentsummaryPageEl.style.display = 'none';
            if(currentgameAreaEl) {
                currentgameAreaEl.innerHTML = '';
                // X√≥a c√°c data-attribute ƒë·∫øm c√¢u h·ªèi c·ªßa c√°c m√†n
                currentgameAreaEl.removeAttribute('data-questions-counted_vocabMatching');
                currentgameAreaEl.removeAttribute('data-recorded_vocabMatching'); // Quan tr·ªçng
                getEl('check-vocab-fill')?.removeAttribute('data-counted_vocabFill'); // Cho m√†n vocab fill
                currentgameAreaEl.removeAttribute('data-questions-counted_rc');
                currentgameAreaEl.removeAttribute('data-questions-counted_pw');
            }
            clearFeedback(); clearHint();
            if(currentNextStageButtonEl) { currentNextStageButtonEl.classList.add('hidden'); if (!currentNextStageButtonEl.dataset.listenerAttached) { currentNextStageButtonEl.addEventListener('click', loadNextStage); currentNextStageButtonEl.dataset.listenerAttached = 'true';}}

            hideTooltip();
            if (currentInstructionsEl) currentInstructionsEl.innerHTML = `<p>üëã Ch√†o b·∫°n! Vui l√≤ng nh·∫≠p t√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu b√†i h·ªçc "T√¥i kh√¥ng ƒÉn c√°i n√†y".</p>`;
            if (currentgameAreaEl) {
                currentgameAreaEl.innerHTML = ` <div id="player-info" style="margin-bottom: 15px; padding: 20px; background-color: #e0f7fa; border-radius: 8px;"> <label for="player-name" style="display: block; margin-bottom: 8px; font-weight: bold;">T√™n c·ªßa b·∫°n:</label> <input type="text" id="player-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." required style="width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px;"> <button id="start-game-button" style="padding: 10px 20px;">B·∫Øt ƒë·∫ßu!</button> </div> `;
                const startButton = getEl('start-game-button'); const playerNameInput = getEl('player-name');
                if (startButton && playerNameInput) {
                    playerNameInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); startButton.click(); } });
                    startButton.addEventListener('click', () => {
                        const name = playerNameInput.value.trim();
                        if (!name) { alert("Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!"); return; }
                        playerName = name; console.log("Player Name:", playerName);
                        startTimer();
                        loadNextStage();
                    });
                }
            }
            const currentHintButtonEl = hintButtonEl();
            if (currentHintButtonEl && !currentHintButtonEl.dataset.listenerAttached) { currentHintButtonEl.addEventListener('click', showHint); currentHintButtonEl.dataset.listenerAttached = 'true'; }
            else if (currentHintButtonEl) { currentHintButtonEl.classList.add('hidden'); currentHintButtonEl.disabled = false; }
        }

        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }

        // ----- START GAME -----
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
