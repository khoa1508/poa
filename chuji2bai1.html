<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Tiáº¿ng Trung: BÃ i 1 - è®¤è¯†æ–°åŒå­¦ ğŸ¼</title>
    <style>
        /* ----- CSS ----- */
        :root {
            --primary-color: #4A90E2; /* Xanh dÆ°Æ¡ng hiá»‡n Ä‘áº¡i */
            --secondary-color: #50E3C2; /* Xanh ngá»c lam */
            --success-color: #7ED321; /* Xanh lÃ¡ cÃ¢y tÆ°Æ¡i sÃ¡ng */
            --warning-color: #F5A623; /* VÃ ng cam */
            --danger-color: #D0021B; /* Äá» */
            --light-color: #FFFFFF; /* Tráº¯ng tinh khiáº¿t */
            --bg-light-gray: #F4F7F6; /* XÃ¡m ráº¥t nháº¡t cho body */
            --card-bg-color: #FFFFFF; /* Ná»n tráº¯ng cho card/section */
            --text-dark-color: #333333; /* MÃ u chá»¯ chÃ­nh Ä‘áº­m */
            --text-light-color: #5F6368; /* MÃ u chá»¯ phá»¥ nháº¡t hÆ¡n */
            --border-color: #E0E6ED; /* MÃ u viá»n nháº¡t */
            --font-family: 'Helvetica Neue', Arial, sans-serif;
            --cute-yellow: #FFF8E1; /* VÃ ng kem nháº¡t hÆ¡n */
        }

        body {
            font-family: var(--font-family);
            line-height: 1.7;
            background-color: var(--bg-light-gray);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Äá»ƒ padding top cÃ³ tÃ¡c dá»¥ng */
            min-height: 100vh;
            padding: 25px; /* TÄƒng padding body */
            margin: 0;
            color: var(--text-dark-color);
            box-sizing: border-box;
        }

        #game-container {
            background-color: var(--card-bg-color);
            padding: 30px 40px; /* TÄƒng padding */
            border-radius: 20px; /* Bo trÃ²n nhiá»u hÆ¡n */
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.08); /* BÃ³ng Ä‘á»• má»m máº¡i hÆ¡n */
            max-width: 850px; /* TÄƒng nháº¹ max-width */
            width: 100%;
            text-align: center;
            box-sizing: border-box;
            opacity: 0;
            transform: translateY(15px);
            animation: fadeInUpSmooth 0.7s ease-out forwards 0.1s;
        }

        @keyframes fadeInUpSmooth {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px; /* TÄƒng margin bottom */
            font-size: 2.4em; /* TÄƒng kÃ­ch thÆ°á»›c */
            font-weight: 700; /* Äáº­m hÆ¡n */
        }

        #timer-section {
            font-size: 1.25em; /* TÄƒng kÃ­ch thÆ°á»›c */
            font-weight: 500;
            margin-bottom: 25px; /* TÄƒng margin */
            color: var(--primary-color);
            background-color: #E9F5FF; /* Ná»n xanh dÆ°Æ¡ng ráº¥t nháº¡t */
            padding: 10px 15px;
            border-radius: 10px;
            display: inline-block; /* Äá»ƒ padding cÃ³ tÃ¡c dá»¥ng Ä‘Ãºng */
        }

        #instructions p {
            background-color: var(--cute-yellow);
            border-left: 6px solid var(--warning-color); /* Viá»n dÃ y hÆ¡n */
            padding: 18px 22px; /* TÄƒng padding */
            border-radius: 10px; /* Bo trÃ²n nhiá»u hÆ¡n */
            margin-bottom: 25px;
            text-align: left;
            font-size: 1.1em;
            color: var(--text-light-color);
            box-shadow: 0 3px 8px rgba(245, 166, 35, 0.15); /* BÃ³ng Ä‘á»• nháº¹ cho instruction */
        }
        #instructions p i { /* Emoji or icon */
            margin-right: 8px;
            font-size: 1.2em;
        }


        #game-area {
            margin-bottom: 25px;
            text-align: left;
        }

        .stage-title {
            font-size: 1.8em; /* TÄƒng kÃ­ch thÆ°á»›c */
            color: var(--secondary-color); /* DÃ¹ng mÃ u phá»¥ */
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color); /* Viá»n dÆ°á»›i rÃµ hÆ¡n */
        }

        /* MÃ n 1.1: KÃ©o tháº£ */
        #vocab-matching-area {
            display: flex;
            justify-content: space-between; /* CÃ¡ch Ä‘á»u hÆ¡n */
            margin-bottom: 25px;
            min-height: 320px;
            flex-wrap: wrap;
            gap: 20px; /* ThÃªm khoáº£ng cÃ¡ch giá»¯a cÃ¡c cá»™t */
        }
        .vocab-list-column, .meaning-list-column {
            flex: 1; /* Cho phÃ©p co giÃ£n */
            min-width: 280px; /* TÄƒng Ä‘á»™ rá»™ng tá»‘i thiá»ƒu */
            padding: 15px; /* TÄƒng padding */
            border: 2px dashed var(--border-color); /* Viá»n rÃµ hÆ¡n */
            border-radius: 10px;
            background-color: #F9FAFB; /* Ná»n xÃ¡m ráº¥t nháº¡t cho cá»™t */
        }
        .draggable-item {
            background-color: var(--light-color);
            padding: 10px 15px; /* TÄƒng padding */
            margin: 8px 0; /* TÄƒng margin */
            border-radius: 8px; /* Bo trÃ²n nhiá»u hÆ¡n */
            cursor: grab;
            border: 1px solid #E5E7EB; /* Viá»n nháº¡t */
            text-align: center;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .draggable-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }
        .drop-target {
            background-color: #F0F9FF; /* Ná»n xanh nháº¡t cho Ã´ tháº£ */
            padding: 18px 15px; /* TÄƒng padding */
            margin: 8px 0;
            border-radius: 8px;
            border: 2px dashed var(--primary-color);
            min-height: 45px; /* TÄƒng chiá»u cao tá»‘i thiá»ƒu */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .drop-target.over { border-style: solid; background-color: #D6EFFF; border-color: var(--primary-color); }
        .drop-target.dropped-correct .draggable-item { background-color: var(--success-color); color: white; cursor: default; border-color: #6ABC74; }
        .drop-target.incorrect-drop .draggable-item { background-color: var(--danger-color); color: white; border-color: #C0392B; }


        /* MÃ n 1.2: Äiá»n tá»« (Dropdown) */
        .fill-sentence { margin-bottom: 15px; font-size: 1.15em; line-height: 2; }
        .fill-sentence select {
            padding: 8px 10px; /* TÄƒng padding */
            font-size: 1em;
            margin: 0 8px; /* TÄƒng margin */
            border-radius: 6px; /* Bo trÃ²n nhiá»u hÆ¡n */
            border: 1px solid var(--border-color);
            background-color: var(--light-color);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
            transition: border-color 0.2s ease;
        }
        .fill-sentence select:focus {
            border-color: var(--primary-color);
            outline: none;
        }


        /* MÃ n 2.1: HoÃ n thÃ nh cÃ¢u */
        .sentence-completion-item { margin-bottom: 18px; }
        .sentence-completion-item label { display: block; margin-bottom: 8px; font-weight: normal; line-height: 1.8; color: var(--text-light-color); }
        .sentence-completion-item input[type="text"] {
            width: calc(100% - 24px); /* Full width with padding */
            padding:10px 12px; /* TÄƒng padding */
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1.05em;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .sentence-completion-item input[type="text"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15);
            outline: none;
        }


        /* MÃ n 3: Äá»c hiá»ƒu */
        .reading-passage-container {
            background-color: #F9FAFB; /* Ná»n xÃ¡m ráº¥t nháº¡t */
            padding: 20px; /* TÄƒng padding */
            border-radius: 10px;
            margin-bottom: 25px;
            line-height: 1.8; /* TÄƒng giÃ£n dÃ²ng */
            text-align: left;
            max-height: 350px; /* TÄƒng chiá»u cao tá»‘i Ä‘a */
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        .reading-passage-container p { margin-bottom: 0 !important; /* Adjusted for dialogue */ padding: 3px 0; }
        .reading-passage-container .dialogue-line { margin-bottom: 0.5em; } /* Space between lines */
        .reading-narrative { color: var(--text-light-color); font-style: italic; margin-bottom: 12px !important; display: block; }
        .speaker { font-weight: 700; }
        .speaker-zhang { color: var(--speaker-zhang-color); }
        .speaker-pu { color: var(--speaker-pu-color); }
        .speaker-shanxia { color: var(--speaker-shanxia-color); }
        .speaker-feng { color: var(--speaker-feng-color); }
        .speaker-chen { color: var(--speaker-chen-color); }

        .reading-question { margin-bottom: 18px; }
        .reading-question label { display: block; margin-bottom: 8px; font-weight: 500; /* Äáº­m vá»«a */ }
        .reading-question textarea, .reading-question input[type="text"] {
            width: calc(100% - 24px); /* Full width with padding */
            padding: 12px; /* TÄƒng padding */
            border: 1px solid var(--border-color);
            border-radius: 6px;
            min-height: 35px;
            font-size: 1em;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .reading-question textarea:focus, .reading-question input[type="text"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15);
            outline: none;
        }


        /* MÃ n 4.1: Äáº·t cÃ¢u (tá»«ng tá»«) */
        #sc-current-word-area {
            margin-bottom: 25px;
            padding: 20px; /* TÄƒng padding */
            background-color: var(--cute-yellow);
            border-radius: 12px; /* Bo trÃ²n nhiá»u hÆ¡n */
            text-align: center;
            border: 1px solid #FDE68A; /* Viá»n vÃ ng nháº¡t */
        }
        #sc-current-word-hanzi { font-size: 2em; font-weight: 700; display: block; margin-bottom: 8px; color: var(--primary-color); }
        #sc-current-word-pinyin { font-size: 1.2em; color: var(--text-light-color); display: block;}
        #sc-current-word-meaning { font-size: 1.05em; color: #71717A; display: block; margin-top: 8px; font-style: italic;}
        #sc-sentence-input {
            box-sizing: border-box;
            width: 100%;
            padding: 18px; /* TÄƒng padding */
            font-size: 1.15em; /* TÄƒng font size */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-height: 90px; /* TÄƒng chiá»u cao */
            margin-bottom: 20px;
            display: block;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
         #sc-sentence-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15);
            outline: none;
        }


        /* MÃ n 5.1: Viáº¿t Ä‘oáº¡n */
        #paragraph-writing-prompt {
            background-color: #E9F5FF; /* Ná»n xanh dÆ°Æ¡ng ráº¥t nháº¡t */
            padding: 20px; /* TÄƒng padding */
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: left;
            font-size: 1em; /* TÄƒng nháº¹ font size */
            border: 1px solid #BEE3F8; /* Viá»n xanh nháº¡t */
        }
        #paragraph-writing-prompt h4 { margin-top: 0; color: var(--primary-color); }
        #paragraph-input {
            width: calc(100% - 24px); /* Full width with padding */
            min-height: 180px; /* TÄƒng chiá»u cao */
            padding: 15px; /* TÄƒng padding */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1.05em;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #paragraph-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15);
            outline: none;
        }
        #char-count { font-size: 0.95em; color: var(--text-light-color); text-align: right; margin-top: 5px; }


        #feedback-section {
            margin-top: 20px;
            padding: 15px 20px; /* TÄƒng padding */
            border-radius: 8px;
            min-height: 35px; /* TÄƒng chiá»u cao tá»‘i thiá»ƒu */
            display: none;
            word-wrap: break-word;
            text-align: left;
            font-size: 1.05em; /* TÄƒng font size */
            box-shadow: 0 3px 8px rgba(0,0,0,0.07);
        }
        #feedback-section.correct { background-color: #E6FFFA; color: #047857; border: 1px solid #99F6E4;} /* Xanh mint */
        #feedback-section.incorrect { background-color: #FFF1F2; color: #C21E3D; border: 1px solid #FFD6D9;} /* Há»“ng nháº¡t */
        #feedback-section.info { background-color: #EBF8FF; color: #2C5282; border: 1px solid #BEE3F8;} /* Xanh dÆ°Æ¡ng nháº¡t */
        #feedback-section strong { display: block; margin-bottom: 8px; font-weight: 600;}

        button { /* NÃºt báº¥m chung, cÃ³ thá»ƒ tÃ¹y chá»‰nh thÃªm cho tá»«ng loáº¡i */
            background-image: linear-gradient(to right, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            padding: 14px 30px; /* TÄƒng padding */
            border-radius: 30px; /* Bo trÃ²n nhiá»u hÆ¡n (hÃ¬nh viÃªn thuá»‘c) */
            cursor: pointer;
            font-size: 1.05em; /* TÄƒng nháº¹ font size */
            font-weight: 600; /* Äáº­m hÆ¡n */
            transition: all 0.3s ease;
            margin: 10px 5px;
            letter-spacing: 0.5px; /* ThÃªm khoáº£ng cÃ¡ch chá»¯ */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            opacity: 0.9;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0px) scale(0.98);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        button:disabled {
            background-image: none;
            background-color: #D1D5DB; /* MÃ u xÃ¡m cho nÃºt bá»‹ vÃ´ hiá»‡u hÃ³a */
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        #summary-page {
            background-color: #F0F9FF; /* Ná»n xanh dÆ°Æ¡ng ráº¥t nháº¡t */
            padding: 35px; /* TÄƒng padding */
            border-radius: 15px;
            margin-top: 30px;
            text-align: left;
            display: none;
            border: 2px solid var(--primary-color); /* Viá»n rÃµ hÆ¡n */
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }
        #summary-page h2 { text-align: center; color: var(--primary-color); font-size: 1.9em; margin-bottom: 25px;}
        #summary-page p { font-size: 1.15em; margin-bottom: 12px;}
        #summary-errors { padding-left: 0; list-style-type: none; } /* Bá» dáº¥u Ä‘áº§u dÃ²ng máº·c Ä‘á»‹nh */
        #summary-errors li {
            color: var(--danger-color);
            margin-bottom: 8px;
            padding: 10px; /* TÄƒng padding */
            background-color: #FFF1F2; /* Ná»n há»“ng nháº¡t cho lá»—i */
            border-radius: 6px;
            border-left: 4px solid var(--danger-color);
        }
        #summary-errors li strong { color: var(--text-dark-color); }
        #summary-errors small { color: #718096; display: block; margin-top: 4px; } /* MÃ u xÃ¡m cho chi tiáº¿t lá»—i */

        .hidden { display: none !important; }
        #skip-stage-button {
            background-image: linear-gradient(to right, var(--warning-color) 0%, #FBBF24 100%); /* Gradient vÃ ng */
            color: var(--text-dark-color);
            margin-left: 15px;
        }
        #hint-button {
             background-image: linear-gradient(to right, #A78BFA 0%, #7C3AED 100%); /* Gradient tÃ­m */
        }
        #restart-button {
             background-image: linear-gradient(to right, var(--secondary-color) 0%, #34D399 100%); /* Gradient xanh ngá»c */
        }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>Game Tiáº¿ng Trung: BÃ i 1 - è®¤è¯†æ–°åŒå­¦ ğŸ¤</h1>
        <div id="timer-section">â³ Thá»i gian: <span id="timer">00:00</span></div>
        <div id="instructions"><p>ğŸ’– ChÃ o má»«ng báº¡n Ä‘áº¿n vá»›i BÃ i 1! HÃ£y cÃ¹ng khÃ¡m phÃ¡ nhÃ©!</p></div>
        <div id="game-area"></div>
        <div id="hint-section" style="text-align: center; margin-top:15px;"><button id="hint-button" class="hidden">ğŸ’¡ Gá»£i Ã½ cho tÃ´i nÃ o!</button><p id="hint-text" style="margin-top:10px; font-style:italic; color: var(--text-light-color);"></p></div>
        <div id="feedback-section"><p id="feedback-text"></p></div>
        <div id="navigation-buttons" style="margin-top: 25px; text-align: center;">
            <button id="next-stage-button" class="hidden">Tiáº¿p tá»¥c MÃ n Sau â–¶ï¸</button>
            <button id="skip-stage-button">Bá» Qua MÃ n NÃ y (Test) â©</button>
        </div>
    </div>
    <div id="summary-page">
        <h2>ğŸ‰ HoÃ n ThÃ nh BÃ i Há»c! ğŸ‰</h2>
        <p>TÃªn há»c viÃªn: <span id="summary-player-name"></span></p>
        <p>Tá»•ng thá»i gian: <span id="summary-time"></span></p>
        <p>Sá»‘ cÃ¢u Ä‘Ãºng: <span id="summary-correct"></span> (Tá»•ng sá»‘ má»¥c Ä‘Ã£ lÃ m: <span id="total-questions-summary"></span>)</p>
        <p>Sá»‘ cÃ¢u sai/chÆ°a hoÃ n háº£o: <span id="summary-incorrect"></span></p>
        <h3>Chi tiáº¿t lá»—i/nháº­n xÃ©t:</h3>
        <ul id="summary-errors"></ul>
        <button id="restart-button">ChÆ¡i láº¡i tá»« Ä‘áº§u ğŸ”</button>
        </div>

    <script>
        // ----- Dá»® LIá»†U TRÃ’ CHÆ I BÃ€I 1: è®¤è¯†æ–°åŒå­¦ -----
        const vocabMatchingData_B1 = [
            { id: 1, hanzi: 'æ™ºæ…§', pinyin: 'zhÃ¬huÃ¬', meaning: 'trÃ­ tuá»‡ / wisdom' },
            { id: 2, hanzi: 'æ¥è‡ª', pinyin: 'lÃ¡izÃ¬', meaning: 'Ä‘áº¿n tá»« / come from' },
            { id: 3, hanzi: 'è¯—(æ­Œ)', pinyin: 'shÄ«(gÄ“)', meaning: 'thÆ¡ ca / poetry' },
            { id: 4, hanzi: 'å“²å­¦', pinyin: 'zhÃ©xuÃ©', meaning: 'triáº¿t há»c / philosophy' },
            { id: 5, hanzi: 'å°†æ¥', pinyin: 'jiÄnglÃ¡i', meaning: 'tÆ°Æ¡ng lai / future' },
            { id: 6, hanzi: 'è®¡åˆ’', pinyin: 'jÃ¬huÃ ', meaning: 'káº¿ hoáº¡ch / plan' },
            { id: 7, hanzi: 'é€šè¿‡', pinyin: 'tÅngguÃ²', meaning: 'thÃ´ng qua, vÆ°á»£t qua / pass' },
            { id: 8, hanzi: 'æµåˆ©', pinyin: 'liÃºlÃ¬', meaning: 'lÆ°u loÃ¡t / fluent' },
            { id: 9, hanzi: 'ä¼˜ç§€', pinyin: 'yÅuxiÃ¹', meaning: 'Æ°u tÃº, xuáº¥t sáº¯c / excellent' },
            { id: 10, hanzi: 'å­”å­', pinyin: 'KÇ’ngzÇ', meaning: 'Khá»•ng Tá»­ / Confucius' },
            { id: 11, hanzi: 'å›å­', pinyin: 'jÅ«nzÇ', meaning: 'quÃ¢n tá»­ / man of noble virtue' },
            { id: 12, hanzi: 'å›å­å°šå¾·', pinyin: 'jÅ«nzÇ shÃ ng dÃ©', meaning: 'ngÆ°á»i quÃ¢n tá»­ coi trá»ng Ä‘á»©c háº¡nh / an exemplary person esteems virtue' },
            { id: 13, hanzi: 'æ€è€ƒ', pinyin: 'sÄ«kÇo', meaning: 'suy nghÄ©, tÆ° duy / think' },
            { id: 14, hanzi: 'ç¡®å®', pinyin: 'quÃ¨shÃ­', meaning: 'quáº£ thá»±c, thá»±c sá»± / indeed' },
            { id: 15, hanzi: 'æ¯”å¦‚', pinyin: 'bÇrÃº', meaning: 'vÃ­ dá»¥ / for example' },
            { id: 16, hanzi: 'æ•™è‚²', pinyin: 'jiÃ oyÃ¹', meaning: 'giÃ¡o dá»¥c / education; educate' },
            { id: 17, hanzi: 'æ‰“äº¤é“', pinyin: 'dÇ jiÄodao', meaning: 'giao tiáº¿p, tiáº¿p xÃºc / have dealings with' },
            { id: 18, hanzi: 'è”ç³»', pinyin: 'liÃ¡nxÃ¬', meaning: 'liÃªn há»‡, káº¿t ná»‘i / contact; connect' },
            { id: 19, hanzi: 'å¯†åˆ‡', pinyin: 'mÃ¬qiÃ¨', meaning: 'máº­t thiáº¿t, thÃ¢n thiáº¿t / close' },
            { id: 20, hanzi: 'æœ¬ç§‘', pinyin: 'bÄ›nkÄ“', meaning: 'Ä‘áº¡i há»c (cá»­ nhÃ¢n) / undergraduate course' },
            { id: 21, hanzi: 'æ¯•ä¸š', pinyin: 'bÃ¬yÃ¨', meaning: 'tá»‘t nghiá»‡p / graduate' }
        ];

        const vocabFillData_B1_Set1 = {
            options: ["å°†æ¥", "æ¥è‡ª", "é€šè¿‡", "å“²å­¦", "è®¡åˆ’", "æµåˆ©"],
            sentences: [
                { parts: ["æˆ‘å«é™ˆæ–°é˜³, ", { placeholderID: "vf1_1_1", answer: "æ¥è‡ª" }, " é©¬æ¥è¥¿äºšã€‚æˆ‘å–œæ¬¢ä¸­å›½è¯—æ­Œ, æ‰“ç®— ", { placeholderID: "vf1_1_2", answer: "å°†æ¥" }, " åšæ±‰è¯­è€å¸ˆã€‚æˆ‘è¦åŠªåŠ›å­¦ä¹ , å¸Œæœ›äºŒå¹´çº§èƒ½ ", { placeholderID: "vf1_1_3", answer: "é€šè¿‡" }, " HSK6çº§è€ƒè¯•ã€‚"] },
                { parts: ["æˆ‘å–œæ¬¢ä¸­å›½ ", { placeholderID: "vf1_2_1", answer: "å“²å­¦" }, ", æ‰€ä»¥æˆ‘æ¥ä¸­å›½ç•™å­¦ã€‚æˆ‘ ", { placeholderID: "vf1_2_2", answer: "è®¡åˆ’" }, " å¥½å¥½å­¦ä¹ æ±‰è¯­, å¸Œæœ›åˆ°ä¸‰å¹´çº§èƒ½ ", { placeholderID: "vf1_2_3", answer: "æµåˆ©" }, " åœ°è¯´æ±‰è¯­, ä¹Ÿèƒ½è¯»æ‡‚å­”å­è¯´è¿‡çš„è¯ã€‚"] }
            ]
        };

        const vocabFillData_B1_Set2 = {
            options: ["æœ¬ç§‘", "æ‰“äº¤é“", "æ¯•ä¸š", "ç¡®å®", "è”ç³»", "æ¯”å¦‚"],
            sentences: [
                { parts: ["æˆ‘æ˜¯ ", { placeholderID: "vf2_3_1", answer: "æœ¬ç§‘" }, " ä¸€å¹´çº§çš„å­¦ç”Ÿ, å­¦ä¹ æ±‰è¯­ä¸“ä¸šã€‚æˆ‘æ‰“ç®— ", { placeholderID: "vf2_3_2", answer: "æ¯•ä¸š" }, " ä»¥åå½“ä¸€åå°å­¦è€å¸ˆã€‚æ¯å¤©å’Œå­©å­ä»¬ ", { placeholderID: "vf2_3_3", answer: "æ‰“äº¤é“" }, " å¤šå¼€å¿ƒå•Š!"] },
                { parts: ["æ¥ä¸­å›½ä»¥å, æˆ‘ç»å¸¸æ€è€ƒä¸€äº›é—®é¢˜ã€‚ ", { placeholderID: "vf2_4_1", answer: "æ¯”å¦‚" }, " , æˆ‘çš„æ±‰è¯­è¿˜ä¸å¤ªæµåˆ©, ç”¨æ±‰è¯­è¯´è¯ ", { placeholderID: "vf2_4_2", answer: "ç¡®å®" }, " æœ‰ç‚¹å„¿éš¾, æ‰€ä»¥æˆ‘å¾—å¤š ", { placeholderID: "vf2_4_3", answer: "è”ç³»" }, " æˆ‘çš„ä¸­å›½æœ‹å‹ä»¬, å¤šå’Œä»–ä»¬ç»ƒä¹ å£è¯­ã€‚"] }
            ]
        };

        const sentenceCompletionData_B1 = [
            { id: "scb1_1", starter: "æˆ‘çš„åå­—", hint: "çˆ¸çˆ¸ç»™èµ·çš„ï¼Œä»–å¸Œæœ›æˆ‘", exampleSuffix: "ã€‚(Gá»£i Ã½: å¸Œæœ›...)" },
            { id: "scb1_2", starter: "æˆ‘", hint: "å¾·å›½ï¼Œæˆ‘çš„ä¸“ä¸šæ˜¯", exampleSuffix: "ã€‚(Gá»£i Ã½: æ¥è‡ª)" },
            { id: "scb1_3", starter: "æˆ‘å¯¹", hint: "ç‰¹åˆ«æ„Ÿå…´è¶£ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©å­¦ä¹ è¿™ä¸ªä¸“ä¸šã€‚", exampleSuffix: "(Gá»£i Ã½: å¯¹...æ„Ÿå…´è¶£)" },
            { id: "scb1_4", starter: "", hint: "æ±‰è¯­å¥½çš„è¯ï¼Œ", exampleSuffix: "æ¯”è¾ƒå®¹æ˜“æ‰¾åˆ°å¥½å·¥ä½œã€‚(Gá»£i Ã½: ...çš„è¯ï¼Œå°±...)" },
            { id: "scb1_5", starter: "æˆ‘æ‰“ç®—", hint: "ï¼Œå¸Œæœ›å°†æ¥èƒ½", exampleSuffix: "ã€‚(Gá»£i Ã½: æ‰“ç®—..., å¸Œæœ›...)" },
            { id: "scb1_6", starter: "é™¤äº†", hint: "ä»¥å¤–ï¼Œæˆ‘è¿˜æƒ³", exampleSuffix: "ã€‚(Gá»£i Ã½: é™¤äº†...ä»¥å¤–ï¼Œè¿˜... )" },
            { id: "scb1_7", starter: "æˆ‘æƒ³å‘", hint: "å­¦ä¹ ï¼ŒæŠŠ", exampleSuffix: "ä»‹ç»ç»™", hint2: "ã€‚(Gá»£i Ã½: å‘...å­¦ä¹ ï¼ŒæŠŠ...ä»‹ç»ç»™... )" }
        ];

        const KET_VAN_1_TEXT = `(æ–°å­¦æœŸ,å…¨ç­è¦èšé¤,å¤§å®¶æ­£åœ¨å•†é‡å»åƒä»€ä¹ˆã€‚)
<span class="speaker speaker-zhang">å¼ å°è–‡:</span> åŒå­¦ä»¬,å‘¨äº”ä¸‹è¯¾åæˆ‘ä»¬ä¸€èµ·å»åƒä¸ªé¥­æ€ä¹ˆæ ·?
<span class="speaker speaker-pu">æœ´æ™ºæ…§:</span> å¥½å•Š,ä½ ä»¬æƒ³åƒä»€ä¹ˆ?
<span class="speaker speaker-shanxia">å±±ä¸‹å’Œä¹Ÿ:</span> å»åƒå››å·ç«é”…å§!æˆ‘ä¸€ç›´éƒ½æƒ³è¯•è¯•å·èœã€‚
<span class="speaker speaker-pu">æœ´æ™ºæ…§:</span> å››å·ç«é”…?æˆ‘å’Œæœ‹å‹åƒè¿‡ä¸€æ¬¡,è¾£å¾—æˆ‘ç›´æµçœ¼æ³ªã€‚æˆ‘å—ä¸äº†ä¸­å›½çš„è¾£æ¤’,ä¹Ÿä¸å¤ªå–œæ¬¢ç¾Šè‚‰ã€‚
<span class="speaker speaker-feng">å†¯å°šå¾·:</span> é‚£å’±ä»¬æ¢ä¸ªé¥­é¦†ã€‚å±±ä¸‹,æ—¥æœ¬äººéƒ½ä¸åƒç¾Šè‚‰å—?
<span class="speaker speaker-shanxia">å±±ä¸‹å’Œä¹Ÿ:</span> å¤§éƒ¨åˆ†æ—¥æœ¬äººéƒ½ä¸å¤ªå–œæ¬¢ç¾Šè‚‰ã€‚æ—¥æœ¬é¥®é£Ÿæ¸…æ·¡,æ‰€ä»¥å‘³é“æ¯”è¾ƒé‡çš„é£Ÿç‰©ä¸å¤ªå—æ¬¢è¿,åŒ…æ‹¬åŠ¨ç‰©çš„å†…è„ã€‚
<span class="speaker speaker-zhang">å¼ å°è–‡:</span> æˆ‘è§‰å¾—æœ€å¥½æ‰¾ä¸€ä¸ªæ¸…çœŸé¥­é¦†,æ–°é˜³æ˜¯ç©†æ–¯æ—ã€‚
<span class="speaker speaker-chen">é™ˆæ–°é˜³:</span> è°¢è°¢å°è–‡!æˆ‘ä¸åƒéæ¸…çœŸçš„è‚‰é£Ÿã€‚
<span class="speaker speaker-feng">å†¯å°šå¾·:</span> é‚£æˆ‘ä»¬å»åƒä»€ä¹ˆ?å°è–‡,ä½ çŸ¥é“å“ªå„¿æœ‰å¥½åƒçš„å—?
<span class="speaker speaker-zhang">å¼ å°è–‡:</span> æˆ‘æƒ³æƒ³ã€‚å°šå¾·ã€æ™ºæ…§,ä½ ä»¬ä¿©æœ‰ä»€ä¹ˆä¸åƒçš„å—?å¯¹ä»€ä¹ˆé£Ÿç‰©è¿‡æ•?
<span class="speaker speaker-feng">å†¯å°šå¾·:</span> è¿‡æ•å€’æ²¡æœ‰,ä½†æ˜¯æˆ‘ä¹Ÿä¸å–œæ¬¢åƒå†…è„ã€é¸¡çˆªå­ä¹‹ç±»çš„ã€‚å†…è„æœ‰ç§å¥‡æ€ªçš„å‘³é“,é¸¡çˆªå­çœ‹èµ·æ¥åƒäººçš„æ‰‹ã€‚å¯¹æˆ‘æ¥è¯´è¿™äº›éƒ½æ˜¯â€œé»‘æš—æ–™ç†â€ã€‚
<span class="speaker speaker-pu">æœ´æ™ºæ…§:</span> æˆ‘ä¸æƒ³åƒå¿«é¤ç­‰å¤ªæ²¹è…»çš„é£Ÿç‰©,ä¸å¥åº·,æœ€å…³é”®çš„æ˜¯åƒä¸€å£å°±èƒ–ã€‚ä¸è¿‡è¿™æ ·ä¸€æ¥,ä¹Ÿå°‘äº†å¾ˆå¤šåƒå¿«é¤çš„å¿«ä¹ã€‚
<span class="speaker speaker-zhang">å¼ å°è–‡:</span> åˆå¥½åƒåˆå¥åº·çš„çƒ¤é±¼?
<span class="speaker speaker-shanxia">å±±ä¸‹å’Œä¹Ÿ</span>ã€<span class="speaker speaker-chen">é™ˆæ–°é˜³</span>ã€<span class="speaker speaker-feng">å†¯å°šå¾·</span>ã€<span class="speaker speaker-pu">æœ´æ™ºæ…§:</span> åŒæ„!
<span class="speaker speaker-zhang">å¼ å°è–‡:</span> é‚£æˆ‘ä»¬å»åƒæ¸…çœŸçƒ¤é±¼å§,æœ‰è¾£çš„,ä¹Ÿæœ‰ä¸è¾£çš„,è¿˜å¯ä»¥æ”¾äº›è”¬èœã€‚`;

        const readingCompData_B1_B = {
            title: "Pháº§n 3.B: Äá»c è¯¾æ–‡(ä¸€) vÃ  tráº£ lá»i",
            passage: KET_VAN_1_TEXT, // Sá»­ dá»¥ng biáº¿n Ä‘Ã£ format
            questions: [
                { id: "rcB_1", promptBefore: "ä¸ºä»€ä¹ˆå«è¿™ä¸ªåå­—ï¼Ÿæœ´æ™ºæ…§ï¼š (å¸Œæœ›, èªæ˜) ", promptAfter: ""},
                { id: "rcB_2", promptBefore: "é©¬æ³¢ç½—ï¼š (å‘â€¦å­¦ä¹ , æŠŠ) ", promptAfter: ""},
                { id: "rcB_3", promptBefore: "å†¯å°šå¾·ï¼š (å­”å­, å›å­) ", promptAfter: ""},
                { id: "rcB_4", promptBefore: "ä¸ºä»€ä¹ˆå­¦æ±‰è¯­ï¼Ÿé™ˆæ–°é˜³ï¼š (è¯—æ­Œ) ", promptAfter: ""},
                { id: "rcB_5", promptBefore: "å†¯å°šå¾·ï¼š (å¯¹â€¦æ„Ÿå…´è¶£) ", promptAfter: ""},
                { id: "rcB_6", promptBefore: "å±±ä¸‹å’Œä¹Ÿï¼š (â€¦çš„è¯) ", promptAfter: ""},
                { id: "rcB_7", promptBefore: "æœ´æ™ºæ…§ï¼š (å°†æ¥) ", promptAfter: ""},
                { id: "rcB_8", promptBefore: "é©¬æ³¢ç½—ï¼š (åƒâ€¦é‚£æ ·) ", promptAfter: ""},
                { id: "rcB_9", promptBefore: "å¼ å°è–‡ï¼š (äº†è§£) ", promptAfter: ""}
            ],
            subQuestionsLearningPlan: [
                { id: "rcB_lp1", promptBefore: "æœ‰å“ªäº›å­¦ä¹ è®¡åˆ’ï¼Ÿé™ˆæ–°é˜³ï¼š (æ‰“ç®—, é€šè¿‡) ", promptAfter: ""},
                { id: "rcB_lp2", promptBefore: "å±±ä¸‹å’Œä¹Ÿï¼š (å…ˆâ€¦, åŠå¹´ä»¥åâ€¦) ", promptAfter: ""},
                { id: "rcB_lp3", promptBefore: "é©¬æ³¢ç½—ï¼š (å¾—, æµåˆ©) ", promptAfter: ""},
                { id: "rcB_lp4", promptBefore: "å¼ å°è–‡ï¼š (æƒ³, ä¼˜ç§€) ", promptAfter: ""}
            ]
        };

        const DOAN_VAN_1_TEXT = `æˆ‘å«ä¸æ€æ€ã€‚æˆ‘çš„åå­—æ˜¯æˆ‘çˆ¸çˆ¸ç»™èµ·çš„ã€‚æˆ‘çˆ¸çˆ¸å¸Œæœ›æˆ‘åšä¸€ä¸ªæœ‰æ™ºæ…§çš„äººï¼Œé‡äº‹å¤šæ€è€ƒï¼Œæ‰€ä»¥ç»™æˆ‘èµ·äº†è¿™ä¸ªåå­—ã€‚æˆ‘å¸¸å¸¸æ€è€ƒå„ç§å„æ ·çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä¸ºä»€ä¹ˆè¦å­¦ä¹ ï¼Ÿæˆ‘å°†æ¥è¦åšä»€ä¹ˆæ ·çš„äººï¼Ÿ æˆ‘æ˜¯æ²³å†…å›½å®¶å¤§å­¦ä¸‹å±å¤–å›½è¯­å¤§å­¦æ•™è‚²å­¦é™¢æœ¬ç§‘ä¸€å¹´çº§çš„å­¦ç”Ÿï¼Œå­¦ä¹ æ±‰è¯­æ•™è‚²ä¸“ä¸šã€‚æˆ‘æ¥è‡ªè¶Šå—é¦–éƒ½æ²³å†…ã€‚ æˆ‘é€‰æ‹©è¿™ä¸ªä¸“ä¸šï¼Œä¸»è¦æ˜¯å› ä¸ºæˆ‘å¯¹ä¸­å›½æ–‡åŒ–å¾ˆæ„Ÿå…´è¶£ï¼Œç‰¹åˆ«æ˜¯ä¸­å›½å¤ä»£å“²å­¦å’Œæ•™è‚²æ€æƒ³ã€‚æˆ‘å¸Œæœ›å°†æ¥èƒ½æˆä¸ºä¸€åä¼˜ç§€çš„æ±‰è¯­è€å¸ˆï¼ŒæŠŠä¸­å›½æ–‡åŒ–ä»‹ç»ç»™æ›´å¤šçš„è¶Šå—å­¦ç”Ÿã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæˆ‘è®¡åˆ’åœ¨å¤§å­¦æœŸé—´åŠªåŠ›å­¦ä¹ ä¸“ä¸šçŸ¥è¯†ï¼Œå¤šè·Ÿä¸­å›½è€å¸ˆå’ŒåŒå­¦æ‰“äº¤é“ï¼Œæé«˜è‡ªå·±çš„æ±‰è¯­æ°´å¹³ã€‚æˆ‘è¿˜æ‰“ç®—ç”³è¯·å»ä¸­å›½äº¤æµå­¦ä¹ ä¸€å¹´ï¼Œäº²èº«ä½“éªŒä¸­å›½æ–‡åŒ–ã€‚æ¯•ä¸šä»¥åï¼Œæˆ‘æƒ³å…ˆåœ¨ä¸€æ‰€ä¸­å­¦å½“æ±‰è¯­è€å¸ˆï¼Œç§¯ç´¯ä¸€äº›æ•™å­¦ç»éªŒï¼Œç„¶åå†è€ƒè™‘è¯»ç ”ç©¶ç”Ÿã€‚ æˆ‘è§‰å¾—å’Œå­¦ç”Ÿä»¬æ‰“äº¤é“æ˜¯ä¸€ä»¶éå¸¸æœ‰æ„æ€çš„äº‹æƒ…ï¼Œèƒ½å¸®åŠ©ä»–ä»¬å­¦ä¹ å’Œæˆé•¿ï¼Œæˆ‘æ„Ÿåˆ°å¾ˆå¼€å¿ƒã€‚æˆ‘ç›¸ä¿¡ï¼Œåªè¦æˆ‘åŠªåŠ›ï¼Œæˆ‘çš„ç†æƒ³ä¸€å®šèƒ½å®ç°ã€‚ `;

        const readingCompData_B1_C = {
            title: "Pháº§n 3.C: Äá»c çŸ­æ–‡(ä¸€) (ä¸æ€æ€) vÃ  tráº£ lá»i",
            passage: DOAN_VAN_1_TEXT,
            questions: [
                { id: "rcC_1", text: "å¥¹å«ä»€ä¹ˆåå­—ï¼Ÿçˆ¸çˆ¸å¦ˆå¦ˆä¸ºä»€ä¹ˆç»™å¥¹èµ·è¿™ä¸ªåå­—ï¼Ÿ(æ€è€ƒ)", keywords: ["æ€è€ƒ"] },
                { id: "rcC_2", text: "å¥¹å¸¸å¸¸æ€è€ƒä»€ä¹ˆé—®é¢˜ï¼Ÿ(å„ç§å„æ ·, æ¯”å¦‚)", keywords: ["å„ç§å„æ ·", "æ¯”å¦‚"] },
                { id: "rcC_3", text: "å¥¹å­¦ä»€ä¹ˆä¸“ä¸šï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ(æ•™è‚², æ¥è‡ª)", keywords: ["æ•™è‚²", "æ¥è‡ª"] },
                { id: "rcC_4", text: "å¥¹æœ‰å“ªäº›è®¡åˆ’ï¼Ÿ(å¤š, å°†æ¥)", keywords: ["å¤š", "å°†æ¥"] },
                { id: "rcC_5", text: "å¥¹è§‰å¾—åšä»€ä¹ˆäº‹æƒ…å¾ˆæœ‰æ„æ€ï¼Ÿ(å’Œâ€¦æ‰“äº¤é“)", keywords: ["å’Œâ€¦æ‰“äº¤é“"] }
            ]
        };

        const sentenceCreationWords_B1 = [
            { hanzi: 'æ™ºæ…§', pinyin: 'zhÃ¬huÃ¬', meaning: 'trÃ­ tuá»‡ / wisdom' }, { hanzi: 'æ¥è‡ª', pinyin: 'lÃ¡izÃ¬', meaning: 'Ä‘áº¿n tá»« / come from' },
            { hanzi: 'è®¡åˆ’', pinyin: 'jÃ¬huÃ ', meaning: 'káº¿ hoáº¡ch / plan' }, { hanzi: 'é€šè¿‡', pinyin: 'tÅngguÃ²', meaning: 'thÃ´ng qua, vÆ°á»£t qua / pass' },
            { hanzi: 'æµåˆ©', pinyin: 'liÃºlÃ¬', meaning: 'lÆ°u loÃ¡t / fluent' }, { hanzi: 'ä¼˜ç§€', pinyin: 'yÅuxiÃ¹', meaning: 'Æ°u tÃº, xuáº¥t sáº¯c / excellent' },
            { hanzi: 'æ€è€ƒ', pinyin: 'sÄ«kÇo', meaning: 'suy nghÄ©, tÆ° duy / think' }, { hanzi: 'æ¯”å¦‚', pinyin: 'bÇrÃº', meaning: 'vÃ­ dá»¥ / for example' },
            { hanzi: 'æ‰“äº¤é“', pinyin: 'dÇ jiÄodao', meaning: 'giao tiáº¿p, tiáº¿p xÃºc / have dealings with' }, { hanzi: 'å¯†åˆ‡', pinyin: 'mÃ¬qiÃ¨', meaning: 'máº­t thiáº¿t, thÃ¢n thiáº¿t / close' }
        ];

        const paragraphWritingData_B1 = {
            title: "è‡ªæˆ‘ä»‹ç» (Tá»± giá»›i thiá»‡u)",
            instructions: "Dá»±a theo cáº¥u trÃºc \"ä»»åŠ¡ä¸€ è‡ªæˆ‘ä»‹ç»\" (PDF trang 12)\nHÃ£y viáº¿t má»™t Ä‘oáº¡n vÄƒn giá»›i thiá»‡u báº£n thÃ¢n báº±ng tiáº¿ng Trung, bao gá»“m cÃ¡c ná»™i dung sau:\n1. TÃªn cá»§a báº¡n.\n2. Táº¡i sao báº¡n cÃ³ tÃªn Ä‘Ã³? (CÃ³ thá»ƒ tá»± sÃ¡ng táº¡o náº¿u khÃ´ng cÃ³ cÃ¢u chuyá»‡n Ä‘áº·c biá»‡t)\n3. ChuyÃªn ngÃ nh cá»§a báº¡n lÃ  gÃ¬? (Hoáº·c mÃ´n há»c báº¡n yÃªu thÃ­ch náº¿u chÆ°a cÃ³ chuyÃªn ngÃ nh)\n4. Táº¡i sao báº¡n há»c chuyÃªn ngÃ nh/mÃ´n há»c Ä‘Ã³?\n5. Báº¡n cÃ³ nhá»¯ng káº¿ hoáº¡ch há»c táº­p nÃ o?",
            structureHint: "Cáº¥u trÃºc gá»£i Ã½ sau:\nå¤§å®¶å¥½ï¼Œæˆ‘å« [Äiá»n tÃªn cá»§a báº¡n]ã€‚\næˆ‘ä¸ºä»€ä¹ˆå«è¿™ä¸ªåå­—å‘¢ï¼Ÿ [Giáº£i thÃ­ch Ã½ nghÄ©a tÃªn cá»§a báº¡n hoáº·c lÃ½ do cÃ³ tÃªn Ä‘Ã³]ã€‚\næˆ‘çš„ä¸“ä¸šæ˜¯ [Äiá»n chuyÃªn ngÃ nh cá»§a báº¡n]ã€‚ (Hoáº·c: æˆ‘å–œæ¬¢çš„ç§‘ç›®æ˜¯...)\næˆ‘ä¸ºä»€ä¹ˆå­¦ä¹ è¿™ä¸ªä¸“ä¸šå‘¢ï¼Ÿ (Hoáº·c: æˆ‘ä¸ºä»€ä¹ˆå–œæ¬¢è¿™ä¸ªç§‘ç›®å‘¢ï¼Ÿ) [Giáº£i thÃ­ch lÃ½ do]ã€‚\næˆ‘æœ‰å¾ˆå¤šå­¦ä¹ è®¡åˆ’ï¼Œæ¯”å¦‚ï¼š[NÃªu má»™t vÃ i káº¿ hoáº¡ch há»c táº­p, vÃ­ dá»¥: æˆ‘æ‰“ç®—æ¯å¤©ç»ƒä¹ æ±‰è¯­å£è¯­åŠä¸ªå°æ—¶ï¼Œå¸Œæœ›ä¸€å¹´ä»¥åèƒ½é€šè¿‡HSK4çº§è€ƒè¯•ã€‚æˆ‘è¿˜æƒ³å¤šçœ‹ä¸­å›½ç”µå½±ï¼Œäº†è§£ä¸­å›½æ–‡åŒ–ã€‚]ã€‚",
            vocabHint: "Tá»« vá»±ng cÃ³ thá»ƒ sá»­ dá»¥ng (tham kháº£o PDF trang 13 ):\nå§“å: æ™ºæ…§, æ€è€ƒ, å‘éŸ³åƒ...\nä¸“ä¸š: è¯—(æ­Œ), å“²å­¦, æ•™è‚², æ‰“äº¤é“, è”ç³», å¯†åˆ‡, æ–‡å­¦, å›½é™…å…³ç³», å›½é™…ç»æµ, é‡‘èè´¸æ˜“, è®¡ç®—æœº\nè®¡åˆ’: å°†æ¥, è®¡åˆ’, é€šè¿‡, æµåˆ©, ä¼˜ç§€, æœ¬ç§‘, æ¯•ä¸š, å®ä¹ , å¤–äº¤å®˜, ç†æƒ³\nå…¶ä»–: æ¥è‡ª, ç¡®å®, æ¯”å¦‚"
        };

        // ----- BIáº¾N TRáº NG THÃI GAME -----
        let currentStage = 0; let gameStages = []; let totalQuestionsInGame = 0;
        let startTime; let timerInterval;
        let gameResults = { correct: 0, incorrect: 0, errors: [], totalTime: '00:00' };
        let playerName = "";
        let currentVocabMatchingPairs = []; let currentFillSentenceIndex = 0; let currentSentenceCompletionIndex = 0; let currentReadingQuestionIndex = 0; let currentSentenceCreationWordIndex_B1 = 0;
        let currentTargetWordForSC_B1 = null;

        // ----- DOM ELEMENTS -----
        const getEl = (id) => document.getElementById(id);
        const timerEl = () => getEl('timer'); const instructionsEl = () => getEl('instructions'); const gameAreaEl = () => getEl('game-area'); const hintButtonEl = () => getEl('hint-button'); const hintTextEl = () => getEl('hint-text'); const feedbackSectionEl = () => getEl('feedback-section'); const feedbackTextEl = () => getEl('feedback-text'); const nextStageButtonEl = () => getEl('next-stage-button'); const skipStageButtonEl = () => getEl('skip-stage-button'); const summaryPageEl = () => getEl('summary-page'); const gameContainerEl = () => getEl('game-container');


        // ----- FUNCTIONS -----
        // --- Helper Functions (Shuffle, Timer, UI, Feedback, AI) ---
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
        function startTimer() { startTime = Date.now(); if(timerInterval) clearInterval(timerInterval); timerInterval = setInterval(updateTimer, 1000); updateTimer(); }
        function updateTimer() { const currentTimerEl = timerEl(); if (!currentTimerEl) { if (timerInterval) clearInterval(timerInterval); return; } const elapsedTime = Math.floor((Date.now() - startTime) / 1000); const minutes = Math.floor(elapsedTime / 60).toString().padStart(2, '0'); const seconds = (elapsedTime % 60).toString().padStart(2, '0'); currentTimerEl.textContent = `${minutes}:${seconds}`; gameResults.totalTime = `${minutes}:${seconds}`; }
        function stopTimer() { if(timerInterval) clearInterval(timerInterval); timerInterval = null; }
        function setInstructions(htmlContentWithIcon) { const currentInstructionsEl = instructionsEl(); if (currentInstructionsEl) { currentInstructionsEl.innerHTML = `<p><i>ğŸ’–</i> ${htmlContentWithIcon}</p>`; } }
        function showFeedback(isCorrect, message) { const currentFeedbackSectionEl = feedbackSectionEl(); const currentFeedbackTextEl = feedbackTextEl(); if (!currentFeedbackSectionEl || !currentFeedbackTextEl) return; currentFeedbackTextEl.innerHTML = message; currentFeedbackSectionEl.className = ''; currentFeedbackSectionEl.classList.add(isCorrect ? 'correct' : 'incorrect'); currentFeedbackSectionEl.style.display = 'block'; }
        function recordResult(isCorrect, stageName, input, issue) { if (isCorrect) { gameResults.correct++; } else { gameResults.incorrect++; gameResults.errors.push({ stage: stageName, input: input || 'N/A', issue }); } console.log("Game Results Updated:", JSON.stringify(gameResults)); }
        function clearFeedback() { const currentFeedbackSectionEl = feedbackSectionEl(); const currentFeedbackTextEl = feedbackTextEl(); if (!currentFeedbackSectionEl || !currentFeedbackTextEl) return; currentFeedbackTextEl.textContent = ''; currentFeedbackSectionEl.style.display = 'none'; currentFeedbackSectionEl.className = ''; }
        async function showHint() { const currentHintTextEl = hintTextEl(); const currentHintButtonEl = hintButtonEl(); if (!currentHintTextEl || !currentHintButtonEl) return; currentHintButtonEl.disabled = true; currentHintTextEl.textContent = "ğŸ§  AI Ä‘ang táº¡o gá»£i Ã½..."; let hint = "Chá»©c nÄƒng gá»£i Ã½ chÆ°a sáºµn sÃ ng cho mÃ n nÃ y."; const currentStageLoader = gameStages[currentStage-1]; if (currentStageLoader) { const stageName = currentStageLoader.name; if (stageName === 'loadSentenceCreationStage_B1' && currentTargetWordForSC_B1) { hint = `HÃ£y thá»­ Ä‘áº·t má»™t cÃ¢u hoÃ n chá»‰nh vá»›i tá»« "${currentTargetWordForSC_B1.hanzi}" (${currentTargetWordForSC_B1.pinyin}) cÃ³ nghÄ©a lÃ  "${currentTargetWordForSC_B1.meaning}".`;} else if (stageName === 'loadVocabFillStage_B1_Set1' || stageName === 'loadVocabFillStage_B1_Set2') { hint = "Chá»n tá»« báº¡n cho lÃ  Ä‘Ãºng nháº¥t vá»›i ngá»¯ cáº£nh cÃ¢u."; } } currentHintTextEl.textContent = hint; currentHintButtonEl.disabled = false; }
        function clearHint() { const currentHintTextEl = hintTextEl(); if (currentHintTextEl) currentHintTextEl.textContent = ''; }

        async function callAI(prompt) {
            const currentFeedbackEl = feedbackTextEl(); const currentFeedbackSectionEl = feedbackSectionEl();
            let purpose = "AI Check";
            if (prompt.includes("táº¡o má»™t gá»£i Ã½")) { purpose = "Generate Hint"; }

            console.log(`--- Calling AI (Gemini Flash) for ${purpose} ---`); console.log(prompt);
            if (!currentFeedbackEl || !currentFeedbackSectionEl) { console.error("Feedback elements not found!"); return { isCorrect: false, explanation: "Lá»—i giao diá»‡n." }; }

            if (purpose !== 'Generate Hint') { currentFeedbackEl.textContent = "ğŸ§  AI Ä‘ang suy nghÄ©..."; currentFeedbackSectionEl.className = ''; currentFeedbackSectionEl.classList.add('info'); currentFeedbackSectionEl.style.display = 'block'; }
            else { hintTextEl().textContent = "ğŸ§  AI Ä‘ang táº¡o gá»£i Ã½..."; }

            const apiKey = 'AIzaSyA7JKJYFmL8L05PDzoekqlu40A_BTWgrkE';

            const modelName = 'gemini-1.5-flash-latest';
            const apiEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            const generationConfig = { temperature: 0.3, maxOutputTokens: 600 };
            const safetySettings = [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }, ];

            try {
                const response = await fetch(apiEndpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ contents: [{ parts: [{ "text": prompt }] }], generationConfig: generationConfig, safetySettings: safetySettings }), });
                if (!response.ok) { let errorData; try { errorData = await response.json(); } catch (e) { errorData = { error: { message: await response.text() || 'Unknown API error' } }; } throw new Error(`API Error ${response.status}: ${errorData?.error?.message || response.statusText}`); }
                const data = await response.json();
                if (!data.candidates || data.candidates.length === 0 || !data.candidates[0].content || !data.candidates[0].content.parts || data.candidates[0].content.parts.length === 0) {
                    let blockReason = data?.promptFeedback?.blockReason || 'No candidate parts in response.';
                    if (data?.candidates && data.candidates[0]?.finishReason && data.candidates[0].finishReason !== "STOP") {
                        blockReason += ` Finish Reason: ${data.candidates[0].finishReason}.`;
                    }
                    throw new Error(`AI response blocked or empty. Reason: ${blockReason}`);
                }
                const aiTextResponse = data.candidates[0].content.parts[0].text;
                console.log("AI Raw Response:", aiTextResponse);

                if (purpose === 'Generate Hint') { return { explanation: aiTextResponse }; }
                else {
                    let lowerResponse = aiTextResponse.toLowerCase(); let isCorrect = false;
                    if (lowerResponse.startsWith("Ä‘Ã¡nh giÃ¡: Ä‘Ãºng") || lowerResponse.startsWith("Ä‘Ã¡nh giÃ¡: Ä‘Ãºng.")) { isCorrect = true; }
                    else if (lowerResponse.startsWith("Ä‘Ã¡nh giÃ¡ tá»•ng thá»ƒ: Ä‘Ãºng")) { isCorrect = true; }

                    let explanation = aiTextResponse;
                    if (isCorrect) {
                        const nháº­nXÃ©tMarker = "nháº­n xÃ©t:";
                        const nháº­nXÃ©tIndex = lowerResponse.indexOf(nháº­nXÃ©tMarker);
                        if (nháº­nXÃ©tIndex !== -1) {
                            explanation = "ÄÃ¡nh giÃ¡: ÄÃºng. " + aiTextResponse.substring(nháº­nXÃ©tIndex + nháº­nXÃ©tMarker.length).trim();
                        } else if (!lowerResponse.startsWith("Ä‘Ã¡nh giÃ¡: Ä‘Ãºng")) {
                             explanation = "ÄÃ¡nh giÃ¡: ÄÃºng. " + aiTextResponse;
                        }
                    }
                    return { isCorrect, explanation };
                }
            } catch (error) {
                console.error(`Error calling ${modelName} API for ${purpose}:`, error);
                let errorMessage = "Lá»—i khi gá»i AI. Vui lÃ²ng thá»­ láº¡i hoáº·c bá» qua.";
                if (error.message.includes("API Key not valid")) {
                    errorMessage = "Lá»—i: API Key khÃ´ng há»£p lá»‡. Vui lÃ²ng kiá»ƒm tra láº¡i API Key.";
                } else if (error.message.includes("API Error 429")) {
                    errorMessage = "Lá»—i: VÆ°á»£t quÃ¡ giá»›i háº¡n yÃªu cáº§u tá»›i AI. Vui lÃ²ng thá»­ láº¡i sau Ã­t phÃºt.";
                } else if (error.message.includes("AI response blocked")) {
                    errorMessage = "Lá»—i: Pháº£n há»“i tá»« AI bá»‹ cháº·n do váº¥n Ä‘á» an toÃ n hoáº·c ná»™i dung khÃ´ng phÃ¹ há»£p. Chi tiáº¿t: " + error.message;
                }

                if (purpose === 'Generate Hint') { hintTextEl().textContent = errorMessage; hintButtonEl().disabled = false; return { explanation: errorMessage }; }
                else { currentFeedbackEl.textContent = errorMessage; currentFeedbackSectionEl.className = ''; currentFeedbackSectionEl.classList.add('incorrect'); currentFeedbackSectionEl.style.display = 'block'; throw error; }
            }
        }

        // ----- STAGE LOADING AND CHECKING FUNCTIONS (BÃ€I 1) -----
        function loadVocabMatchingStage_B1() {
            setInstructions("ğŸ¤ MÃ n 1.1: Ná»‘i Tá»«. KÃ©o tá»« tiáº¿ng Trung (HÃ¡n tá»± & Pinyin) vÃ o Ã´ nghÄ©a tiáº¿ng Viá»‡t tÆ°Æ¡ng á»©ng.");
            const gameArea = gameAreaEl();
            hintButtonEl()?.classList.add('hidden');

            const words = vocabMatchingData_B1.map(item => ({ id: item.id, text: `${item.hanzi} (${item.pinyin})`}));
            const meanings = vocabMatchingData_B1.map(item => ({ id: item.id, text: item.meaning }));
            shuffleArray(words);
            shuffleArray(meanings);

            let wordHTML = words.map(w => `<div class="draggable-item" draggable="true" data-id="${w.id}">${w.text}</div>`).join('');
            let meaningHTML = meanings.map(m => `<div class="drop-target" data-target-id="${m.id}"><span class="meaning-text">${m.text}</span></div>`).join('');

            gameArea.innerHTML = `
                <h3 class="stage-title">BÃ i 1.1: Ná»‘i Tá»« Vá»›i Pinyin vÃ  NghÄ©a</h3>
                <div id="vocab-matching-area">
                    <div class="vocab-list-column" id="drag-source-column">${wordHTML}</div>
                    <div class="meaning-list-column" id="drop-target-column">${meaningHTML}</div>
                </div>
                <button id="check-matching-b1">Kiá»ƒm Tra Ná»‘i Tá»«</button>
            `;
            addDragDropListeners_B1();
            getEl('check-matching-b1').addEventListener('click', checkVocabMatching_B1);
        }

        function addDragDropListeners_B1() {
            const draggables = document.querySelectorAll('.draggable-item');
            const targets = document.querySelectorAll('.drop-target');
            let draggedItem = null;

            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', (e) => {
                    draggedItem = draggable;
                    e.dataTransfer.setData('text/plain', draggable.dataset.id);
                    setTimeout(() => draggable.style.opacity = '0.5', 0);
                });
                draggable.addEventListener('dragend', () => {
                    setTimeout(() => {
                        draggable.style.opacity = '1';
                        draggedItem = null;
                    }, 0);
                });
            });

            targets.forEach(target => {
                target.addEventListener('dragover', (e) => { e.preventDefault(); target.classList.add('over'); });
                target.addEventListener('dragleave', () => { target.classList.remove('over'); });
                target.addEventListener('drop', (e) => {
                    e.preventDefault();
                    target.classList.remove('over');
                    if (draggedItem && !target.querySelector('.draggable-item')) {
                        target.appendChild(draggedItem);
                    } else if (draggedItem) {
                        console.log("Target already has an item or no dragged item.");
                    }
                });
            });
        }

        function checkVocabMatching_B1() {
            let correctMatches = 0;
            const targets = document.querySelectorAll('.drop-target');
            targets.forEach(target => {
                const droppedWordEl = target.querySelector('.draggable-item');
                target.classList.remove('dropped-correct', 'incorrect-drop');
                if (droppedWordEl) {
                    const wordId = droppedWordEl.dataset.id;
                    const targetId = target.dataset.targetId;
                    if (wordId === targetId) {
                        correctMatches++;
                        target.classList.add('dropped-correct');
                         const wordInside = target.querySelector('.draggable-item');
                         if(wordInside) wordInside.draggable = false;
                    } else {
                        target.classList.add('incorrect-drop');
                    }
                }
            });
            if(gameStages[currentStage-1]?.name === "loadVocabMatchingStage_B1" && !getEl('check-matching-b1').dataset.counted) {
                totalQuestionsInGame += vocabMatchingData_B1.length;
                getEl('check-matching-b1').dataset.counted = 'true';
            }
            recordResult(correctMatches === vocabMatchingData_B1.length, "BÃ i 1.1 Ná»‘i tá»«", `ÄÃºng ${correctMatches}/${vocabMatchingData_B1.length}`, correctMatches === vocabMatchingData_B1.length ? "" : "Má»™t sá»‘ cáº·p ná»‘i chÆ°a Ä‘Ãºng.");
            showFeedback(correctMatches === vocabMatchingData_B1.length, `Báº¡n Ä‘Ã£ ná»‘i Ä‘Ãºng ${correctMatches} / ${vocabMatchingData_B1.length} cáº·p.`);
            if (correctMatches === vocabMatchingData_B1.length) {
                nextStageButtonEl()?.classList.remove('hidden');
                getEl('check-matching-b1').disabled = true;
                const sourceColumn = getEl('drag-source-column');
                if (sourceColumn) sourceColumn.innerHTML = "<p style='color:grey; text-align:center;'>ÄÃ£ hoÃ n thÃ nh!</p>";
            }
        }

        function loadVocabFillStage_B1_Set1() {
            setInstructions("âœï¸ MÃ n 1.2 (Set 1): Chá»n Tá»«. Chá»n tá»« thÃ­ch há»£p tá»« danh sÃ¡ch Ä‘á»ƒ Ä‘iá»n vÃ o chá»— trá»‘ng.");
            const gameArea = gameAreaEl();
            hintButtonEl()?.classList.add('hidden');

            let sentencesHTML = vocabFillData_B1_Set1.sentences.map((sentenceData, index) => {
                let sentenceHTML = `<div class="fill-sentence" id="vf1_sentence_${index + 1}"><span>${index + 1}. </span>`;
                sentenceData.parts.forEach(part => {
                    if (typeof part === 'string') {
                        sentenceHTML += `<span>${part}</span>`;
                    } else {
                        sentenceHTML += `<select id="${part.placeholderID}">`;
                        sentenceHTML += `<option value="">---Chá»n---</option>`;
                        vocabFillData_B1_Set1.options.forEach(opt => {
                            sentenceHTML += `<option value="${opt}">${opt}</option>`;
                        });
                        sentenceHTML += `</select>`;
                    }
                });
                sentenceHTML += `</div>`;
                return sentenceHTML;
            }).join('');

            gameArea.innerHTML = `
                <h3 class="stage-title">BÃ i 1.2: Chá»n Tá»« (Set 1)</h3>
                <p style="font-style:italic;"><strong>Tá»« Ä‘á»ƒ chá»n:</strong> ${vocabFillData_B1_Set1.options.join(' â€¢ ')}</p>
                ${sentencesHTML}
                <button id="check-vocab-fill-s1">Kiá»ƒm Tra Äiá»n Tá»« (Set 1)</button>
            `;
            getEl('check-vocab-fill-s1').addEventListener('click', () => checkVocabFill_B1(vocabFillData_B1_Set1, "check-vocab-fill-s1", "BÃ i 1.2 Set 1"));
        }

        function loadVocabFillStage_B1_Set2() {
            setInstructions("âœï¸ MÃ n 1.2 (Set 2): Chá»n Tá»«. Chá»n tá»« thÃ­ch há»£p tá»« danh sÃ¡ch Ä‘á»ƒ Ä‘iá»n vÃ o chá»— trá»‘ng.");
            const gameArea = gameAreaEl();
            hintButtonEl()?.classList.add('hidden');

            let sentencesHTML = vocabFillData_B1_Set2.sentences.map((sentenceData, index) => {
                let sentenceHTML = `<div class="fill-sentence" id="vf2_sentence_${index + 1}"><span>${index + 3}. </span>`;
                sentenceData.parts.forEach(part => {
                    if (typeof part === 'string') {
                        sentenceHTML += `<span>${part}</span>`;
                    } else {
                        sentenceHTML += `<select id="${part.placeholderID}">`;
                        sentenceHTML += `<option value="">---Chá»n---</option>`;
                        vocabFillData_B1_Set2.options.forEach(opt => {
                            sentenceHTML += `<option value="${opt}">${opt}</option>`;
                        });
                        sentenceHTML += `</select>`;
                    }
                });
                sentenceHTML += `</div>`;
                return sentenceHTML;
            }).join('');

            gameArea.innerHTML = `
                <h3 class="stage-title">BÃ i 1.2: Chá»n Tá»« (Set 2)</h3>
                <p style="font-style:italic;"><strong>Tá»« Ä‘á»ƒ chá»n:</strong> ${vocabFillData_B1_Set2.options.join(' â€¢ ')}</p>
                ${sentencesHTML}
                <button id="check-vocab-fill-s2">Kiá»ƒm Tra Äiá»n Tá»« (Set 2)</button>
            `;
            getEl('check-vocab-fill-s2').addEventListener('click', () => checkVocabFill_B1(vocabFillData_B1_Set2, "check-vocab-fill-s2", "BÃ i 1.2 Set 2"));
        }

        function checkVocabFill_B1(dataObject, buttonId, stageIdentifier) {
            let correctCount = 0;
            let totalBlanksInThisSet = 0;
            const feedbackMessages = [];
            dataObject.sentences.forEach((sentenceData, sentenceIndex) => {
                sentenceData.parts.forEach(part => {
                    if (typeof part !== 'string') {
                        totalBlanksInThisSet++;
                        const selectEl = getEl(part.placeholderID);
                        if (selectEl) {
                             const selectedValue = selectEl.value;
                             if (selectedValue === part.answer) {
                                 correctCount++;
                                 selectEl.style.borderColor = 'green';
                             } else {
                                 selectEl.style.borderColor = 'red';
                                 feedbackMessages.push(`CÃ¢u ${sentenceIndex + 1} (trong set), chá»— trá»‘ng "${part.answer}" chá»n sai.`);
                             }
                        } else {
                             console.error("KhÃ´ng tÃ¬m tháº¥y select element:", part.placeholderID);
                        }
                    }
                });
            });

            const checkButton = getEl(buttonId);
            if(checkButton && !checkButton.dataset.counted) {
                totalQuestionsInGame += totalBlanksInThisSet;
                checkButton.dataset.counted = 'true';
            }

            recordResult(correctCount === totalBlanksInThisSet, stageIdentifier, `ÄÃºng ${correctCount}/${totalBlanksInThisSet}`, correctCount === totalBlanksInThisSet ? "" : feedbackMessages.join(" "));
            showFeedback(correctCount === totalBlanksInThisSet, `Báº¡n Ä‘Ã£ Ä‘iá»n Ä‘Ãºng ${correctCount} / ${totalBlanksInThisSet} chá»— trá»‘ng. ${correctCount !== totalBlanksInThisSet ? 'HÃ£y xem láº¡i cÃ¡c chá»— bÃ´i Ä‘á».' : ''}`);
            if (correctCount === totalBlanksInThisSet) {
                nextStageButtonEl()?.classList.remove('hidden');
                if(checkButton) checkButton.disabled = true;
            } else {
                if(checkButton) checkButton.disabled = false;
            }
        }

        function loadSentenceCompletionStage_B1() {
            setInstructions("ğŸ“ MÃ n 2.1: HoÃ n ThÃ nh CÃ¢u. Viáº¿t tiáº¿p vÃ o chá»— trá»‘ng Ä‘á»ƒ táº¡o thÃ nh cÃ¢u hoÃ n chá»‰nh, Ä‘Ãºng ngá»¯ phÃ¡p vÃ  tá»± nhiÃªn.");
            const gameArea = gameAreaEl();
            hintButtonEl()?.classList.add('hidden');
            if(!gameArea.dataset.questionsCounted_sc_b1) {
                 totalQuestionsInGame += sentenceCompletionData_B1.length;
                 gameArea.dataset.questionsCounted_sc_b1 = 'true';
            }

            let itemsHTML = sentenceCompletionData_B1.map((item, index) => {
                 return `
                     <div class="sentence-completion-item">
                         <label for="scb1_input_${item.id}">
                             ${index + 1}. ${item.starter}
                             <input type="text" id="scb1_input_${item.id}" placeholder="Viáº¿t tiáº¿p vÃ o Ä‘Ã¢y..." data-hint-text="${item.hint || ''}">
                             ${item.exampleSuffix || ''}
                         </label>
                     </div>`;
             }).join('');

            gameArea.innerHTML = `
                <h3 class="stage-title">BÃ i 2.1: HoÃ n ThÃ nh CÃ¢u</h3>
                ${itemsHTML}
                <button id="check-sc-b1">Kiá»ƒm Tra HoÃ n ThÃ nh CÃ¢u</button>
            `;
            getEl('check-sc-b1').addEventListener('click', checkAllSentenceCompletions_B1);
        }
        async function checkAllSentenceCompletions_B1() {
             const submitButton = getEl('check-sc-b1');
             submitButton.disabled = true; submitButton.textContent = "AI Ä‘ang kiá»ƒm tra..."; clearFeedback();
             let allCorrectThisCheck = true; let stageFeedback = [];

             for (let i = 0; i < sentenceCompletionData_B1.length; i++) {
                 const item = sentenceCompletionData_B1[i];
                 const userInputEl = getEl(`scb1_input_${item.id}`);
                 const userInput = userInputEl.value.trim();
                 const fullSentenceAttempt = item.starter + userInput + (item.exampleSuffix || '');

                 if (!userInput) {
                     userInputEl.style.borderColor = 'red'; allCorrectThisCheck = false;
                     recordResult(false, `BÃ i 2.1 CÃ¢u ${i+1}`, "ChÆ°a nháº­p", "ChÆ°a hoÃ n thÃ nh cÃ¢u.");
                     stageFeedback.push(`CÃ¢u ${i+1}: Báº¡n chÆ°a hoÃ n thÃ nh cÃ¢u.`);
                     userInputEl.placeholder = "Vui lÃ²ng Ä‘iá»n vÃ o Ä‘Ã¢y!";
                 } else {
                     // UPDATED PROMPT for Sentence Completion
                     const prompt = `
                        Báº¡n lÃ  má»™t giÃ¡o viÃªn tiáº¿ng Trung Ä‘ang cháº¥m bÃ i cho há»c sinh.
                        Nhiá»‡m vá»¥: Há»c sinh cáº§n Ä‘iá»n vÃ o chá»— trá»‘ng Ä‘á»ƒ hoÃ n thÃ nh cÃ¢u.
                        CÃ¢u cho sáºµn cÃ³ dáº¡ng: "${item.starter} ______ ${item.exampleSuffix || ''}"
                        Pháº§n há»c sinh Ä‘iá»n vÃ o chá»— trá»‘ng (______): "${userInput}"
                        CÃ¢u Ä‘áº§y Ä‘á»§ mÃ  há»c sinh táº¡o ra lÃ : "${fullSentenceAttempt}"

                        YÃªu cáº§u Ä‘Ã¡nh giÃ¡ CHÃNH:
                        1.  **Ngá»¯ phÃ¡p:** Pháº§n Ä‘iá»n ("${userInput}") cÃ³ lÃ m cho cÃ¢u Ä‘áº§y Ä‘á»§ ("${fullSentenceAttempt}") Ä‘Ãºng ngá»¯ phÃ¡p tiáº¿ng Trung khÃ´ng?
                        2.  **CÃ¡ch dÃ¹ng tá»«:** CÃ¡ch dÃ¹ng tá»« trong pháº§n Ä‘iá»n ("${userInput}") cÃ³ phÃ¹ há»£p vÃ  tá»± nhiÃªn khi ghÃ©p vá»›i pháº§n cÃ²n láº¡i cá»§a cÃ¢u khÃ´ng?
                        3.  **Logic vÃ  tá»± nhiÃªn cá»§a cÃ¢u hoÃ n chá»‰nh:** CÃ¢u Ä‘áº§y Ä‘á»§ ("${fullSentenceAttempt}") cÃ³ logic, Ã½ nghÄ©a rÃµ rÃ ng vÃ  nghe tá»± nhiÃªn khÃ´ng?
                        LÆ¯U Ã: KHÃ”NG cáº§n há»c sinh pháº£i sá»­ dá»¥ng má»™t tá»« vá»±ng cá»¥ thá»ƒ nÃ o Ä‘Ã³ tá»« gá»£i Ã½ (náº¿u cÃ³). Chá»‰ cáº§n cÃ¢u hoÃ n chá»‰nh Ä‘Ãºng vÃ  tá»± nhiÃªn.

                        Äá»‹nh dáº¡ng tráº£ lá»i Báº®T BUá»˜C:
                        ÄÃ¡nh giÃ¡: [ÄÃºng/Sai]
                        Nháº­n xÃ©t: [Náº¿u Sai, giáº£i thÃ­ch NGáº®N Gá»ŒN lá»—i ngá»¯ phÃ¡p hoáº·c cÃ¡ch dÃ¹ng tá»« trong pháº§n "${userInput}" khiáº¿n cÃ¢u "${fullSentenceAttempt}" chÆ°a Ä‘Ãºng/chÆ°a tá»± nhiÃªn, vÃ  gá»£i Ã½ cÃ¡ch sá»­a NGáº®N Gá»ŒN cho pháº§n "${userInput}". Náº¿u ÄÃºng, ghi "CÃ¢u tá»‘t, ngá»¯ phÃ¡p vÃ  cÃ¡ch dÃ¹ng tá»« phÃ¹ há»£p, tá»± nhiÃªn." hoáº·c khen tÆ°Æ¡ng tá»±.]
                    `;
                     try {
                         const aiResult = await callAI(prompt);
                         recordResult(aiResult.isCorrect, `BÃ i 2.1 CÃ¢u ${i+1}`, fullSentenceAttempt, aiResult.isCorrect ? "" : aiResult.explanation);
                         if (!aiResult.isCorrect) { allCorrectThisCheck = false; userInputEl.style.borderColor = 'red'; }
                         else { userInputEl.style.borderColor = 'green'; }
                         stageFeedback.push(`<strong>CÃ¢u ${i+1}:</strong> ${aiResult.explanation.replace(/\n/g, '<br>')}`);
                     } catch (error) { allCorrectThisCheck = false; recordResult(false, `BÃ i 2.1 CÃ¢u ${i+1}`, fullSentenceAttempt, `Lá»—i API: ${error.message}`); stageFeedback.push(`<strong>CÃ¢u ${i+1}:</strong> Lá»—i khi kiá»ƒm tra vá»›i AI.`); userInputEl.style.borderColor = 'orange'; }
                 }
             }
             showFeedback(allCorrectThisCheck, stageFeedback.join("<br><br>"));
             submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm Tra HoÃ n ThÃ nh CÃ¢u";
             if (allCorrectThisCheck) { nextStageButtonEl()?.classList.remove('hidden'); submitButton.disabled = true; }
        }

        function loadReadingCompStage_B1_A() {
            setInstructions("ğŸ“– MÃ n 3.A: Äá»c Hiá»ƒu. Tráº£ lá»i cÃ¡c cÃ¢u há»i sau.");
            const gameArea = gameAreaEl();
            hintButtonEl()?.classList.add('hidden');
            if(!gameArea.dataset.questionsCounted_rcA) { totalQuestionsInGame += readingCompData_B1_A.questions.length; gameArea.dataset.questionsCounted_rcA = 'true'; }

            let questionsHTML = readingCompData_B1_A.questions.map((q, index) => `
                <div class="reading-question">
                    <label for="rcA_input_${q.id}">${index + 1}. ${q.text}</label>
                    <textarea id="rcA_input_${q.id}" rows="3"></textarea>
                </div>
            `).join('');
            gameArea.innerHTML = `<h3 class="stage-title">${readingCompData_B1_A.title}</h3>${questionsHTML}<button id="check-rcA">Kiá»ƒm Tra</button>`;
            getEl('check-rcA').addEventListener('click', checkAllReadingComp_B1_A);
        }
        async function checkAllReadingComp_B1_A() {
             const submitButton = getEl('check-rcA'); submitButton.disabled = true; submitButton.textContent = "AI Ä‘ang kiá»ƒm tra..."; clearFeedback();
             let allCorrectThisCheck = true; let stageFeedback = [];
             for (let i = 0; i < readingCompData_B1_A.questions.length; i++) {
                 const q = readingCompData_B1_A.questions[i];
                 const userAnswer = getEl(`rcA_input_${q.id}`).value.trim();
                 if(!userAnswer) { allCorrectThisCheck = false; stageFeedback.push(`CÃ¢u ${i+1}: ChÆ°a tráº£ lá»i.`); recordResult(false, `BÃ i 3.A Q${i+1}`, "ChÆ°a nháº­p", "ChÆ°a tráº£ lá»i"); getEl(`rcA_input_${q.id}`).style.borderColor = 'red'; continue;}
                 const prompt = `Báº¡n lÃ  giÃ¡o viÃªn tiáº¿ng Trung. CÃ¢u há»i lÃ : "${q.text}". Há»c sinh tráº£ lá»i báº±ng tiáº¿ng Trung: "${userAnswer}". CÃ¢u tráº£ lá»i cÃ³ phÃ¹ há»£p, logic vÃ  diá»…n Ä‘áº¡t tá»‘t khÃ´ng? Tráº£ lá»i THEO ÄÃšNG Äá»ŠNH Dáº NG: "ÄÃ¡nh giÃ¡: [ÄÃºng/Sai]\nNháº­n xÃ©t: [Nháº­n xÃ©t NGáº®N Gá»ŒN, náº¿u sai Ä‘Æ°a ra gá»£i Ã½ sá»­a]".`;
                 try {
                     const aiResult = await callAI(prompt);
                     recordResult(aiResult.isCorrect, `BÃ i 3.A Q${i+1}`, userAnswer, aiResult.isCorrect ? "" : aiResult.explanation);
                     if(!aiResult.isCorrect) allCorrectThisCheck = false;
                     getEl(`rcA_input_${q.id}`).style.borderColor = aiResult.isCorrect ? 'green' : 'red';
                     stageFeedback.push(`<strong>CÃ¢u ${i+1}:</strong> ${aiResult.explanation.replace(/\n/g, '<br>')}`);
                 } catch (e) { allCorrectThisCheck = false; stageFeedback.push(`<strong>CÃ¢u ${i+1}:</strong> Lá»—i API.`); recordResult(false, `BÃ i 3.A Q${i+1}`, userAnswer, `Lá»—i API: ${e.message}`); getEl(`rcA_input_${q.id}`).style.borderColor = 'orange';}
             }
             showFeedback(allCorrectThisCheck, stageFeedback.join('<br><br>'));
             submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm Tra";
             if(allCorrectThisCheck) {nextStageButtonEl()?.classList.remove('hidden'); submitButton.disabled = true;}
        }

        function loadReadingCompStage_B1_B() {
            setInstructions("ğŸ“– MÃ n 3.B: Äá»c Hiá»ƒu è¯¾æ–‡(ä¸€). Äiá»n vÃ o chá»— trá»‘ng dá»±a vÃ o bÃ i Ä‘á»c vÃ  tá»« khÃ³a.");
            const gameArea = gameAreaEl();
            hintButtonEl()?.classList.add('hidden');
            const questionsB = readingCompData_B1_B.questions.concat(readingCompData_B1_B.subQuestionsLearningPlan);
            if(!gameArea.dataset.questionsCounted_rcB) { totalQuestionsInGame += questionsB.length; gameArea.dataset.questionsCounted_rcB = 'true'; }

            let formattedPassage = readingCompData_B1_B.passage.split('\n').map(line => {
                if (line.startsWith("å¼ å°è–‡:")) return `<p class="dialogue-line"><strong class="speaker speaker-zhang">å¼ å°è–‡:</strong><span>${line.substring("å¼ å°è–‡:".length)}</span></p>`;
                if (line.startsWith("æœ´æ™ºæ…§:")) return `<p class="dialogue-line"><strong class="speaker speaker-pu">æœ´æ™ºæ…§:</strong><span>${line.substring("æœ´æ™ºæ…§:".length)}</span></p>`;
                if (line.startsWith("å±±ä¸‹å’Œä¹Ÿ:")) return `<p class="dialogue-line"><strong class="speaker speaker-shanxia">å±±ä¸‹å’Œä¹Ÿ:</strong><span>${line.substring("å±±ä¸‹å’Œä¹Ÿ:".length)}</span></p>`;
                if (line.startsWith("å†¯å°šå¾·:")) return `<p class="dialogue-line"><strong class="speaker speaker-feng">å†¯å°šå¾·:</strong><span>${line.substring("å†¯å°šå¾·:".length)}</span></p>`;
                if (line.startsWith("é™ˆæ–°é˜³:")) return `<p class="dialogue-line"><strong class="speaker speaker-chen">é™ˆæ–°é˜³:</strong><span>${line.substring("é™ˆæ–°é˜³:".length)}</span></p>`;
                if (line.startsWith("(")) return `<p class="reading-narrative">${line}</p>`;
                return `<p class="dialogue-line">${line}</p>`;
            }).join('');


            let questionsHTML = `<div class="reading-passage-container"><h4>è¯¾æ–‡(ä¸€)</h4>${formattedPassage}</div>`;

            questionsHTML += questionsB.map((q, index) => `
                <div class="reading-question">
                    <label for="rcB_input_${q.id}">
                        ${index + 1}. ${q.promptBefore}
                        <input type="text" id="rcB_input_${q.id}" placeholder="Äiá»n vÃ o Ä‘Ã¢y..." style="width:50%;">
                        ${q.promptAfter || ''}
                    </label>
                </div>
            `).join('');
            gameArea.innerHTML = `<h3 class="stage-title">${readingCompData_B1_B.title}</h3>${questionsHTML}<button id="check-rcB">Kiá»ƒm Tra</button>`;
            getEl('check-rcB').addEventListener('click', checkAllReadingComp_B1_B);
        }
        async function checkAllReadingComp_B1_B() {
             const submitButton = getEl('check-rcB'); submitButton.disabled = true; submitButton.textContent = "AI Ä‘ang kiá»ƒm tra..."; clearFeedback();
             let allCorrectThisCheck = true; let stageFeedback = [];
             const questionsB = readingCompData_B1_B.questions.concat(readingCompData_B1_B.subQuestionsLearningPlan);

             for (let i = 0; i < questionsB.length; i++) {
                 const q = questionsB[i];
                 const userAnswer = getEl(`rcB_input_${q.id}`).value.trim();
                 if(!userAnswer) { allCorrectThisCheck = false; stageFeedback.push(`CÃ¢u ${i+1}: ChÆ°a Ä‘iá»n.`); recordResult(false, `BÃ i 3.B Q${i+1}`, "ChÆ°a nháº­p", "ChÆ°a Ä‘iá»n"); getEl(`rcB_input_${q.id}`).style.borderColor = 'red'; continue; }
                 const questionText = `${q.promptBefore} [TRáº¢ Lá»œI Cá»¦A Há»ŒC SINH] ${q.promptAfter || ''}`;
                 const keywordsForAI = q.promptBefore.match(/\(([^)]+)\)/) ? q.promptBefore.match(/\(([^)]+)\)/)[1] : "KhÃ´ng cÃ³";

                 const prompt = `Báº¡n lÃ  giÃ¡o viÃªn tiáº¿ng Trung. Dá»±a vÃ o Ä‘oáº¡n vÄƒn è¯¾æ–‡(ä¸€): "${readingCompData_B1_B.passage}".\nYÃªu cáº§u: HoÃ n thÃ nh cÃ¢u sau "${q.promptBefore.replace(/\([^)]+\)/g, '______')}${q.promptAfter || ''}" dá»±a vÃ o ná»™i dung bÃ i Ä‘á»c vÃ  sá»­ dá»¥ng cÃ¡c tá»« khÃ³a gá»£i Ã½: ${keywordsForAI}.\nHá»c sinh Ä‘iá»n vÃ o chá»— trá»‘ng lÃ : "${userAnswer}".\nPháº§n Ä‘iá»n cá»§a há»c sinh cÃ³ Ä‘Ãºng vÃ  phÃ¹ há»£p khÃ´ng? Tráº£ lá»i THEO ÄÃšNG Äá»ŠNH Dáº NG: "ÄÃ¡nh giÃ¡: [ÄÃºng/Sai]\nNháº­n xÃ©t: [Giáº£i thÃ­ch NGáº®N Gá»ŒN, náº¿u sai gá»£i Ã½ sá»­a]".`;
                 try {
                     const aiResult = await callAI(prompt);
                     recordResult(aiResult.isCorrect, `BÃ i 3.B Q${i+1}`, userAnswer, aiResult.isCorrect ? "" : aiResult.explanation);
                     if(!aiResult.isCorrect) allCorrectThisCheck = false;
                     getEl(`rcB_input_${q.id}`).style.borderColor = aiResult.isCorrect ? 'green' : 'red';
                     stageFeedback.push(`<strong>CÃ¢u ${i+1}:</strong> ${aiResult.explanation.replace(/\n/g, '<br>')}`);
                 } catch (e) { allCorrectThisCheck = false; stageFeedback.push(`<strong>CÃ¢u ${i+1}:</strong> Lá»—i API.`); recordResult(false, `BÃ i 3.B Q${i+1}`, userAnswer, `Lá»—i API: ${e.message}`); getEl(`rcB_input_${q.id}`).style.borderColor = 'orange';}
             }
             showFeedback(allCorrectThisCheck, stageFeedback.join('<br><br>'));
             submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm Tra";
             if(allCorrectThisCheck) {nextStageButtonEl()?.classList.remove('hidden'); submitButton.disabled = true;}
        }

        function loadReadingCompStage_B1_C() {
            setInstructions("ğŸ“– MÃ n 3.C: Äá»c Hiá»ƒu çŸ­æ–‡(ä¸€). Äá»c Ä‘oáº¡n vÄƒn vÃ  tráº£ lá»i cÃ¢u há»i.");
            const gameArea = gameAreaEl();
            hintButtonEl()?.classList.add('hidden');
            if(!gameArea.dataset.questionsCounted_rcC) { totalQuestionsInGame += readingCompData_B1_C.questions.length; gameArea.dataset.questionsCounted_rcC = 'true'; }

            let questionsHTML = `<div class="reading-passage-container"><h4>çŸ­æ–‡(ä¸€)</h4><p style="font-style:italic; color:grey;">(Ná»™i dung bÃ i Ä‘á»c)</p>${readingCompData_B1_C.passage.replace(/\n/g, '<br>')}</div>`;
            questionsHTML += readingCompData_B1_C.questions.map((q, index) => `
                <div class="reading-question">
                    <label for="rcC_input_${q.id}">${index + 1}. ${q.text}</label>
                    <textarea id="rcC_input_${q.id}" rows="3"></textarea>
                </div>
            `).join('');
            gameArea.innerHTML = `<h3 class="stage-title">${readingCompData_B1_C.title}</h3>${questionsHTML}<button id="check-rcC">Kiá»ƒm Tra</button>`;
            getEl('check-rcC').addEventListener('click', checkAllReadingComp_B1_C);
        }
        async function checkAllReadingComp_B1_C() {
             const submitButton = getEl('check-rcC'); submitButton.disabled = true; submitButton.textContent = "AI Ä‘ang kiá»ƒm tra..."; clearFeedback();
             let allCorrectThisCheck = true; let stageFeedback = [];
             for (let i = 0; i < readingCompData_B1_C.questions.length; i++) {
                 const q = readingCompData_B1_C.questions[i];
                 const userAnswer = getEl(`rcC_input_${q.id}`).value.trim();
                 if(!userAnswer) { allCorrectThisCheck = false; stageFeedback.push(`CÃ¢u ${i+1}: ChÆ°a tráº£ lá»i.`); recordResult(false, `BÃ i 3.C Q${i+1}`, "ChÆ°a nháº­p", "ChÆ°a tráº£ lá»i"); getEl(`rcC_input_${q.id}`).style.borderColor = 'red'; continue; }
                 const prompt = `Báº¡n lÃ  giÃ¡o viÃªn tiáº¿ng Trung. Dá»±a vÃ o Ä‘oáº¡n vÄƒn çŸ­æ–‡(ä¸€): "${readingCompData_B1_C.passage}".\nCÃ¢u há»i lÃ : "${q.text}". YÃªu cáº§u há»c sinh tráº£ lá»i báº±ng tiáº¿ng Trung vÃ  sá»­ dá»¥ng cÃ¡c tá»« khÃ³a gá»£i Ã½: ${q.keywords.join(', ')}.\nHá»c sinh tráº£ lá»i: "${userAnswer}".\nCÃ¢u tráº£ lá»i cÃ³ Ä‘Ãºng, dá»±a trÃªn ná»™i dung Ä‘oáº¡n vÄƒn vÃ  cÃ³ sá»­ dá»¥ng Ä‘Ãºng cÃ¡c tá»« khÃ³a Ä‘Æ°á»£c yÃªu cáº§u khÃ´ng? Tráº£ lá»i THEO ÄÃšNG Äá»ŠNH Dáº NG: "ÄÃ¡nh giÃ¡: [ÄÃºng/Sai]\nNháº­n xÃ©t: [Giáº£i thÃ­ch NGáº®N Gá»ŒN, náº¿u sai gá»£i Ã½ sá»­a]".`;
                 try {
                     const aiResult = await callAI(prompt);
                     recordResult(aiResult.isCorrect, `BÃ i 3.C Q${i+1}`, userAnswer, aiResult.isCorrect ? "" : aiResult.explanation);
                     if(!aiResult.isCorrect) allCorrectThisCheck = false;
                     getEl(`rcC_input_${q.id}`).style.borderColor = aiResult.isCorrect ? 'green' : 'red';
                     stageFeedback.push(`<strong>CÃ¢u ${i+1}:</strong> ${aiResult.explanation.replace(/\n/g, '<br>')}`);
                 } catch (e) { allCorrectThisCheck = false; stageFeedback.push(`<strong>CÃ¢u ${i+1}:</strong> Lá»—i API.`); recordResult(false, `BÃ i 3.C Q${i+1}`, userAnswer, `Lá»—i API: ${e.message}`); getEl(`rcC_input_${q.id}`).style.borderColor = 'orange';}
             }
             showFeedback(allCorrectThisCheck, stageFeedback.join('<br><br>'));
             submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm Tra";
             if(allCorrectThisCheck) {nextStageButtonEl()?.classList.remove('hidden'); submitButton.disabled = true;}
        }

        function loadSentenceCreationStage_B1() {
            setInstructions("ğŸ’¬ MÃ n 4.1: Äáº·t CÃ¢u. HÃ£y Ä‘áº·t má»™t cÃ¢u tiáº¿ng Trung hoÃ n chá»‰nh sá»­ dá»¥ng tá»« cho sáºµn.");
            const gameArea = gameAreaEl();
            hintButtonEl()?.classList.remove('hidden');
            currentSentenceCreationWordIndex_B1 = 0;
            displayCurrentSCWord_B1();
        }
        function displayCurrentSCWord_B1() {
            const gameArea = gameAreaEl();
            if (sentenceCreationWords_B1 && currentSentenceCreationWordIndex_B1 < sentenceCreationWords_B1.length) {
                currentTargetWordForSC_B1 = sentenceCreationWords_B1[currentSentenceCreationWordIndex_B1];
                gameArea.innerHTML = ` <h3 class="stage-title">BÃ i 4.1: Äáº·t CÃ¢u (${currentSentenceCreationWordIndex_B1 + 1}/${sentenceCreationWords_B1.length})</h3> <div id="sc-current-word-area"> <p><strong>HÃ£y Ä‘áº·t cÃ¢u vá»›i tá»«:</strong></p> <span id="sc-current-word-hanzi">${currentTargetWordForSC_B1.hanzi}</span> <span id="sc-current-word-pinyin">(${currentTargetWordForSC_B1.pinyin})</span> <span id="sc-current-word-meaning">${currentTargetWordForSC_B1.meaning}</span> </div> <textarea id="sc-sentence-input" rows="4" placeholder="Viáº¿t cÃ¢u cá»§a báº¡n vÃ o Ä‘Ã¢y..."></textarea> <button id="submit-sc-sentence-b1">Kiá»ƒm Tra CÃ¢u</button> `;
                getEl('submit-sc-sentence-b1').addEventListener('click', handleSubmitSCCurrentSentence_B1);
                clearFeedback(); clearHint(); nextStageButtonEl()?.classList.add('hidden');
            } else {
                console.log("HoÃ n thÃ nh MÃ n 4.1 Äáº·t CÃ¢u.");
                loadNextStage();
            }
        }
        async function handleSubmitSCCurrentSentence_B1() {
            const sentenceInput = getEl('sc-sentence-input'); const sentence = sentenceInput ? sentenceInput.value.trim() : '';
            if (!currentTargetWordForSC_B1) { showFeedback(false, "Lá»—i: KhÃ´ng cÃ³ tá»« má»¥c tiÃªu."); return; }
            if (!sentence) { showFeedback(false, "Báº¡n chÆ°a nháº­p cÃ¢u!"); return; }
            const submitButton = getEl('submit-sc-sentence-b1'); submitButton.disabled = true; submitButton.textContent = "AI Ä‘ang cháº¥m Ä‘iá»ƒm..."; clearFeedback();
            const targetWordInfo = `${currentTargetWordForSC_B1.hanzi} (${currentTargetWordForSC_B1.pinyin}): ${currentTargetWordForSC_B1.meaning}`;
            // UPDATED PROMPT for Sentence Creation
            const prompt = `
                Báº¡n lÃ  má»™t giÃ¡o viÃªn tiáº¿ng Trung.
                Há»c sinh Ä‘Æ°á»£c yÃªu cáº§u Ä‘áº·t má»™t cÃ¢u hoÃ n chá»‰nh báº±ng tiáº¿ng Trung sá»­ dá»¥ng tá»« sau: "${targetWordInfo}".
                CÃ¢u há»c sinh Ä‘áº·t lÃ : "${sentence}".

                HÃ£y Ä‘Ã¡nh giÃ¡ cÃ¢u cá»§a há»c sinh dá»±a trÃªn cÃ¡c tiÃªu chÃ­ CHÃNH:
                1.  **Sá»­ dá»¥ng tá»« khÃ³a:** CÃ¢u cÃ³ sá»­ dá»¥ng Ä‘Ãºng tá»« khÃ³a "${currentTargetWordForSC_B1.hanzi}" khÃ´ng?
                2.  **Ngá»¯ phÃ¡p:** CÃ¢u cÃ³ Ä‘Ãºng ngá»¯ phÃ¡p tiáº¿ng Trung khÃ´ng?
                3.  **Logic vÃ  Ngá»¯ nghÄ©a:** CÃ¢u cÃ³ logic, Ã½ nghÄ©a rÃµ rÃ ng vÃ  phÃ¹ há»£p khÃ´ng?
                4.  **Äá»™ tá»± nhiÃªn:** CÃ¢u cÃ³ nghe tá»± nhiÃªn nhÆ° ngÆ°á»i báº£n xá»© nÃ³i khÃ´ng?
                Quan trá»ng: KHÃ”NG táº­p trung vÃ o viá»‡c cÃ³ theo má»™t "cÃ¢u gá»‘c" nÃ o khÃ´ng, vÃ¬ Ä‘Ã¢y lÃ  Ä‘áº·t cÃ¢u tá»± do vá»›i tá»« cho sáºµn.

                Tráº£ lá»i THEO ÄÃšNG Äá»ŠNH Dáº NG sau:
                ÄÃ¡nh giÃ¡: [ÄÃºng/Sai]
                Nháº­n xÃ©t: [Náº¿u Sai, giáº£i thÃ­ch NGáº®N Gá»ŒN lá»—i sai chÃ­nh (vÃ­ dá»¥: chÆ°a dÃ¹ng tá»« khÃ³a, sai ngá»¯ phÃ¡p, khÃ´ng tá»± nhiÃªn) vÃ  Ä‘Æ°a ra má»™t gá»£i Ã½ cáº£i thiá»‡n cÃ¢u NGáº®N Gá»ŒN. Náº¿u ÄÃºng, ghi "CÃ¢u tá»‘t, sá»­ dá»¥ng Ä‘Ãºng tá»« vÃ  tá»± nhiÃªn." hoáº·c khen tÆ°Æ¡ng tá»±.]
            `;
            try {
                const aiResult = await callAI(prompt);
                const currentWordKey = `sc_b1_${currentTargetWordForSC_B1.hanzi.replace(/\s/g, '_')}`;
                if (!gameAreaEl().dataset[currentWordKey]) {
                     totalQuestionsInGame++;
                     gameAreaEl().dataset[currentWordKey] = 'counted';
                }
                recordResult(aiResult.isCorrect, `BÃ i 4.1 (Tá»«: ${currentTargetWordForSC_B1.hanzi})`, sentence, aiResult.isCorrect ? "" : aiResult.explanation);
                showFeedback(aiResult.isCorrect, aiResult.explanation.replace(/\n/g, '<br>'));
                if (aiResult.isCorrect) { currentSentenceCreationWordIndex_B1++; setTimeout(displayCurrentSCWord_B1, 2000); }
                else { submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm Tra CÃ¢u"; }
            } catch (error) { showFeedback(false, `Lá»—i API: ${error.message}`); submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm Tra CÃ¢u"; }
        }

        function loadParagraphWritingStage_B1() {
            setInstructions("âœï¸ MÃ n 5.1: Viáº¿t Äoáº¡n VÄƒn. HÃ£y viáº¿t má»™t bÃ i tá»± giá»›i thiá»‡u theo gá»£i Ã½.");
            const gameArea = gameAreaEl();
            hintButtonEl()?.classList.add('hidden');
            if(!gameArea.dataset.questionsCounted_pw_b1) {totalQuestionsInGame++; gameArea.dataset.questionsCounted_pw_b1 = 'true';}

            gameArea.innerHTML = ` <h3 class="stage-title">BÃ i 5.1: ${paragraphWritingData_B1.title}</h3> <div id="paragraph-writing-prompt"> <p>${paragraphWritingData_B1.instructions.replace(/\n/g, '<br>')}</p> <h4>Cáº¥u trÃºc gá»£i Ã½:</h4> <p>${paragraphWritingData_B1.structureHint.replace(/\n/g, '<br>')}</p> <h4>Tá»« vá»±ng cÃ³ thá»ƒ sá»­ dá»¥ng:</h4> <p>${paragraphWritingData_B1.vocabHint.replace(/\n/g, '<br>')}</p> </div> <textarea id="paragraph-input" placeholder="Viáº¿t Ä‘oáº¡n vÄƒn cá»§a báº¡n vÃ o Ä‘Ã¢y (khoáº£ng 100-150 chá»¯)..."></textarea> <div id="char-count">0 chá»¯</div> <button id="check-paragraph-writing-b1">Kiá»ƒm Tra Äoáº¡n VÄƒn</button> `;
            const paragraphInputEl = getEl('paragraph-input'); const charCountEl = getEl('char-count');
            paragraphInputEl.addEventListener('input', () => { const charLength = paragraphInputEl.value.length; charCountEl.textContent = `${charLength} chá»¯`; if (charLength > 170 || charLength < 80 && charLength > 0) { charCountEl.style.color = 'red'; } else { charCountEl.style.color = '#6c757d'; } });
            getEl('check-paragraph-writing-b1').addEventListener('click', checkParagraphWriting_B1);
        }
        async function checkParagraphWriting_B1() {
            const paragraphInput = getEl('paragraph-input').value.trim();
            if (paragraphInput.length < 80) { showFeedback(false, "Äoáº¡n vÄƒn cá»§a báº¡n hÆ¡i ngáº¯n, hÃ£y viáº¿t thÃªm nhÃ© (Ã­t nháº¥t 80 chá»¯)."); return; }
            const submitButton = getEl('check-paragraph-writing-b1'); submitButton.disabled = true; submitButton.textContent = "AI Ä‘ang kiá»ƒm tra..."; clearFeedback();
            const prompt = `Báº¡n lÃ  giÃ¡o viÃªn tiáº¿ng Trung. ÄÃ¡nh giÃ¡ Ä‘oáº¡n vÄƒn tá»± giá»›i thiá»‡u sau cá»§a há»c sinh (yÃªu cáº§u khoáº£ng 100-150 chá»¯ báº±ng tiáº¿ng Trung): "${paragraphInput}". Xem xÃ©t sá»± máº¡ch láº¡c, ngá»¯ phÃ¡p, tá»« vá»±ng (cÃ³ sá»­ dá»¥ng tá»« gá»£i Ã½ khÃ´ng?), vÃ  má»©c Ä‘á»™ hoÃ n thÃ nh yÃªu cáº§u Ä‘á» bÃ i (tÃªn, Ã½ nghÄ©a tÃªn, chuyÃªn ngÃ nh/mÃ´n há»c yÃªu thÃ­ch, lÃ½ do, káº¿ hoáº¡ch há»c táº­p). Tráº£ lá»i THEO ÄÃšNG Äá»ŠNH Dáº NG: "ÄÃ¡nh giÃ¡: [Tá»‘t/KhÃ¡/Cáº§n cáº£i thiá»‡n]\nNháº­n xÃ©t: [Nháº­n xÃ©t tá»•ng quan vÃ  2-3 gá»£i Ã½ cáº£i thiá»‡n NGáº®N Gá»ŒN.]"`;
            try {
                const aiResult = await callAI(prompt);
                let isPass = !aiResult.explanation.toLowerCase().includes("cáº§n cáº£i thiá»‡n");
                recordResult(isPass, "BÃ i 5.1 Viáº¿t Ä‘oáº¡n", paragraphInput.substring(0,50)+"...", isPass ? "" : aiResult.explanation);
                showFeedback(isPass, aiResult.explanation.replace(/\n/g, '<br>'));
                if (isPass) { nextStageButtonEl()?.classList.remove('hidden'); submitButton.disabled = true; }
                else { submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm Tra Äoáº¡n VÄƒn"; }
            } catch (error) { showFeedback(false, `Lá»—i API: ${error.message}`); submitButton.disabled = false; submitButton.textContent = "Kiá»ƒm Tra Äoáº¡n VÄƒn"; }
        }

        // ----- QUáº¢N LÃ MÃ€N CHÆ I -----
        function loadNextStage() { // MOVED DEFINITION UP
            currentStage++;
            clearFeedback();
            clearHint();
            const nextBtn = nextStageButtonEl();
            const skipBtn = skipStageButtonEl();
            const hintBtn = hintButtonEl();

            if(nextBtn) nextBtn.classList.add('hidden');

            if (currentStage <= gameStages.length) {
                const stageLoaderFunction = gameStages[currentStage - 1];
                console.log(`Loading stage ${currentStage}: ${stageLoaderFunction.name}`);
                stageLoaderFunction();
                if(hintBtn) hintBtn.classList.remove('hidden');
                if(skipBtn) skipBtn.classList.remove('hidden');
            } else {
                console.log("All stages completed. Showing summary.");
                showSummary();
                if(hintBtn) hintBtn.classList.add('hidden');
                if(skipBtn) skipBtn.classList.add('hidden');
            }
        }

        // ----- Summary Page -----
        function showSummary() {
            stopTimer();
            const currentgameAreaEl = gameAreaEl(); const currentNextStageButtonEl = nextStageButtonEl(); const currentSkipStageButtonEl = skipStageButtonEl(); const currentFeedbackSectionEl = feedbackSectionEl(); const currentHintSectionEl = getEl('hint-section');
            if(currentgameAreaEl) currentgameAreaEl.innerHTML = '<h2>ğŸ‰ Em Ä‘Ã£ hoÃ n thÃ nh táº¥t cáº£ cÃ¡c thá»­ thÃ¡ch! ğŸ‰</h2>';
            if(currentNextStageButtonEl) currentNextStageButtonEl.classList.add('hidden');
            if(currentSkipStageButtonEl) currentSkipStageButtonEl.classList.add('hidden');
            if(currentFeedbackSectionEl) currentFeedbackSectionEl.style.display = 'none';
            if(currentHintSectionEl) currentHintSectionEl.style.display = 'none';

            const summaryPage = summaryPageEl();
            if (summaryPage) {
                getEl('summary-player-name').textContent = playerName || "Há»c viÃªn";
                getEl('summary-time').textContent = gameResults.totalTime;
                getEl('summary-correct').textContent = gameResults.correct;
                getEl('total-questions-summary').textContent = totalQuestionsInGame;
                getEl('summary-incorrect').textContent = gameResults.incorrect;
                const errorsList = getEl('summary-errors');
                errorsList.innerHTML = '';
                if (gameResults.errors.length > 0) {
                    gameResults.errors.forEach(err => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${err.stage}:</strong> "${err.input}" - <small>${err.issue}</small>`;
                        errorsList.appendChild(li);
                    });
                } else {
                    errorsList.innerHTML = '<li>ğŸ¥³ Tuyá»‡t vá»i! KhÃ´ng cÃ³ lá»—i nÃ o Ä‘Æ°á»£c ghi nháº­n.</li>';
                }
                summaryPage.style.display = 'block';
                if (!getEl('restart-button')) {
                    const restartBtn = document.createElement('button');
                    restartBtn.id = 'restart-button';
                    restartBtn.textContent = 'ChÆ¡i láº¡i tá»« Ä‘áº§u ğŸ”';
                    restartBtn.addEventListener('click', initGame);
                    summaryPage.appendChild(restartBtn);
                }
                // DÃ²ng nháº¯c nhá»Ÿ Google Form Ä‘Ã£ Ä‘Æ°á»£c bá»
            } else { console.error("Summary page element not found!"); }
        }

        // ----- Initialization -----
        // MOVED initGame and its DOMContentLoaded listener to the END
        function initGame() {
            console.log("Initializing game: BÃ i 1 - è®¤è¯†æ–°åŒå­¦");
            gameStages = [
                loadVocabMatchingStage_B1,    loadVocabFillStage_B1_Set1,   loadVocabFillStage_B1_Set2,
                loadSentenceCompletionStage_B1, loadReadingCompStage_B1_A,    loadReadingCompStage_B1_B,
                loadReadingCompStage_B1_C,    loadSentenceCreationStage_B1, loadParagraphWritingStage_B1
            ];
            currentStage = 0; totalQuestionsInGame = 0;
            gameResults = { correct: 0, incorrect: 0, errors: [], totalTime: '00:00' };
            playerName = "";
            if (timerInterval) clearInterval(timerInterval); timerInterval = null;
            const currentTimerEl = timerEl(); if(currentTimerEl) currentTimerEl.textContent = '00:00';
            const currentgameContainerEl = gameContainerEl(); const currentsummaryPageEl = summaryPageEl(); const currentgameAreaEl = gameAreaEl(); const currentNextStageButtonEl = nextStageButtonEl(); const currentSkipStageButtonEl = skipStageButtonEl(); const currentInstructionsEl = instructionsEl();

            if(currentgameContainerEl) currentgameContainerEl.classList.remove('hidden');
            if(currentsummaryPageEl) currentsummaryPageEl.style.display = 'none';
            if(currentgameAreaEl) { currentgameAreaEl.innerHTML = ''; delete currentgameAreaEl.dataset.questionsCounted_sc_b1; delete currentgameAreaEl.dataset.questionsCounted_rcA; delete currentgameAreaEl.dataset.questionsCounted_rcB; delete currentgameAreaEl.dataset.questionsCounted_rcC; delete currentgameAreaEl.dataset.questionsCounted_pw_b1; }
            clearFeedback(); clearHint();

            if(currentNextStageButtonEl) { currentNextStageButtonEl.classList.add('hidden'); if (!currentNextStageButtonEl.dataset.listenerAttached) { currentNextStageButtonEl.addEventListener('click', loadNextStage); currentNextStageButtonEl.dataset.listenerAttached = 'true';}}
            if(currentSkipStageButtonEl) { currentSkipStageButtonEl.classList.remove('hidden'); if (!currentSkipStageButtonEl.dataset.listenerAttached) { currentSkipStageButtonEl.addEventListener('click', () => { console.log(`Skipping stage ${currentStage}`); loadNextStage(); }); currentSkipStageButtonEl.dataset.listenerAttached = 'true'; } }

            if (currentInstructionsEl) setInstructions("ğŸ‘‹ ChÃ o báº¡n! Vui lÃ²ng nháº­p tÃªn Ä‘á»ƒ báº¯t Ä‘áº§u bÃ i há»c \"è®¤è¯†æ–°åŒå­¦\".");
            if (currentgameAreaEl) {
                currentgameAreaEl.innerHTML = ` <div id="player-info" style="margin-bottom: 15px; padding: 20px; background-color: #e0f7fa; border-radius: 8px;"> <label for="player-name" style="display: block; margin-bottom: 8px; font-weight: bold;">TÃªn cá»§a báº¡n:</label> <input type="text" id="player-name" placeholder="Nháº­p tÃªn cá»§a báº¡n..." required style="width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px;"> <button id="start-game-button" style="padding: 10px 20px;">Báº¯t Ä‘áº§u!</button> </div> `;
                const startButton = getEl('start-game-button'); const playerNameInput = getEl('player-name');
                if (startButton && playerNameInput) {
                    playerNameInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); startButton.click(); } });
                    startButton.addEventListener('click', () => {
                        const name = playerNameInput.value.trim();
                        if (!name) { alert("Vui lÃ²ng nháº­p tÃªn cá»§a báº¡n!"); return; }
                        playerName = name; console.log("Player Name:", playerName);
                        startTimer();
                        loadNextStage();
                    });
                }
            }
            const currentHintButtonEl = hintButtonEl();
            if (currentHintButtonEl && !currentHintButtonEl.dataset.listenerAttached) { currentHintButtonEl.addEventListener('click', showHint); currentHintButtonEl.dataset.listenerAttached = 'true'; }
            else if (currentHintButtonEl) { currentHintButtonEl.classList.add('hidden'); currentHintButtonEl.disabled = false; }
        }

        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
